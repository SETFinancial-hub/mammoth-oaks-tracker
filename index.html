<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mammoth Oaks Development Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .card-hd { border-left: 4px solid #ef4444; }
        .card-ls { border-left: 4px solid #f59e0b; }
        .card-ap { border-left: 4px solid #8b5cf6; }
        .card-sub { border-left: 4px solid #06b6d4; }
        .card-default { border-left: 4px solid #94a3b8; }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-3xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-emerald-600 flex items-center justify-center shadow-md">
                        <i data-lucide="trees" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900 leading-tight">Mammoth Oaks</h1>
                        <p class="text-xs text-gray-500 font-medium">Development Tracker &bull; 28270</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="refresh-btn" onclick="refreshAllData()" class="flex items-center gap-2 px-4 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl transition-colors text-sm font-medium shadow-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-5">
        <!-- Last Updated -->
        <div class="text-xs text-gray-400 mb-4 text-right" id="last-updated">Loading...</div>

        <!-- Error Banner -->
        <div id="error-banner" class="hidden mb-5 p-4 rounded-2xl bg-red-50 border border-red-200">
            <div class="flex items-start gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0"></i>
                <div>
                    <p class="font-semibold text-red-800 text-sm">Something went wrong</p>
                    <p class="text-sm text-red-600 mt-0.5" id="error-message"></p>
                </div>
            </div>
        </div>

        <!-- Alert Banner -->
        <div id="alert-banner" class="hidden mb-5 p-4 rounded-2xl bg-red-50 border border-red-200">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                </div>
                <div>
                    <p class="font-bold text-red-800" id="alert-count">Loading...</p>
                    <p class="text-sm text-red-600 mt-0.5">Active development proposals near your neighborhood</p>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-5">
            <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                <input type="text" id="search-input"
                       placeholder="Search address, developer, or petition..."
                       oninput="handleSearch(this.value)"
                       class="w-full pl-12 pr-12 py-4 bg-white border border-gray-200 rounded-2xl text-gray-900 placeholder-gray-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 text-base shadow-sm">
                <div id="search-clear" class="hidden absolute right-4 top-1/2 -translate-y-1/2 cursor-pointer text-gray-400 hover:text-gray-700 p-1" onclick="clearSearch()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </div>
            </div>
            <div id="search-results" class="hidden mt-3 p-4 rounded-2xl bg-white border border-gray-200 shadow-lg max-h-96 overflow-y-auto">
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-3 gap-3 mb-5">
            <div onclick="scrollToSection('critical-alerts')" class="p-4 rounded-2xl bg-white border border-gray-200 cursor-pointer hover:shadow-md transition-all text-center shadow-sm">
                <div class="text-3xl font-extrabold text-red-600" id="stat-critical">-</div>
                <div class="text-xs text-gray-500 font-medium mt-1">High Density</div>
            </div>
            <div onclick="scrollToSection('lotsplit-overview')" class="p-4 rounded-2xl bg-white border border-gray-200 cursor-pointer hover:shadow-md transition-all text-center shadow-sm">
                <div class="text-3xl font-extrabold text-amber-600" id="stat-lotsplits">-</div>
                <div class="text-xs text-gray-500 font-medium mt-1">Lot Splits</div>
            </div>
            <div onclick="scrollToSection('nearby-overview')" class="p-4 rounded-2xl bg-white border border-gray-200 cursor-pointer hover:shadow-md transition-all text-center shadow-sm">
                <div class="text-3xl font-extrabold text-emerald-600" id="stat-nearby">-</div>
                <div class="text-xs text-gray-500 font-medium mt-1">Near Us</div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-3 mb-6">
            <div onclick="scrollToSection('approved-overview')" class="p-3 rounded-2xl bg-white border border-gray-200 cursor-pointer hover:shadow-md transition-all text-center shadow-sm">
                <div class="text-2xl font-bold text-purple-600" id="stat-approved">-</div>
                <div class="text-xs text-gray-500 mt-1">Approved</div>
            </div>
            <div onclick="showTab('rezonings')" class="p-3 rounded-2xl bg-white border border-gray-200 cursor-pointer hover:shadow-md transition-all text-center shadow-sm">
                <div class="text-2xl font-bold text-gray-700" id="stat-rezonings">-</div>
                <div class="text-xs text-gray-500 mt-1">Citywide</div>
            </div>
            <div onclick="showTab('sales')" class="p-3 rounded-2xl bg-white border border-gray-200 cursor-pointer hover:shadow-md transition-all text-center shadow-sm">
                <div class="text-2xl font-bold text-blue-600" id="stat-sales">-</div>
                <div class="text-xs text-gray-500 mt-1">Sales</div>
            </div>
        </div>

        <!-- Quick Resource Links -->
        <div class="flex flex-wrap gap-2 mb-6">
            <a href="https://nearme.charlottenc.gov/" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-xl text-xs font-medium hover:bg-emerald-100 transition-colors">
                <i data-lucide="map-pin" class="w-3.5 h-3.5"></i> Development Near Me
            </a>
            <a href="https://polaris3g.mecklenburgcountync.gov/" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-xl text-xs font-medium hover:bg-blue-100 transition-colors">
                <i data-lucide="landmark" class="w-3.5 h-3.5"></i> POLARIS
            </a>
            <a href="https://www.charlottenc.gov/Growth-and-Development/Planning-and-Development/Rezoning" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-50 text-gray-700 border border-gray-200 rounded-xl text-xs font-medium hover:bg-gray-100 transition-colors">
                <i data-lucide="file-text" class="w-3.5 h-3.5"></i> All Rezonings
            </a>
        </div>

        <!-- Tabs -->
        <div class="flex gap-1 mb-5 bg-gray-100 rounded-2xl p-1 overflow-x-auto">
            <button onclick="showTab('overview')" class="tab-btn flex-1 px-3 py-2.5 text-sm font-semibold rounded-xl transition-all bg-white text-gray-900 shadow-sm" data-tab="overview">Overview</button>
            <button onclick="showTab('rezonings')" class="tab-btn flex-1 px-3 py-2.5 text-sm font-medium rounded-xl transition-all text-gray-500 hover:text-gray-700" data-tab="rezonings">All</button>
            <button onclick="showTab('nearby')" class="tab-btn flex-1 px-3 py-2.5 text-sm font-medium rounded-xl transition-all text-gray-500 hover:text-gray-700" data-tab="nearby">Near Us</button>
            <button onclick="showTab('sales')" class="tab-btn flex-1 px-3 py-2.5 text-sm font-medium rounded-xl transition-all text-gray-500 hover:text-gray-700" data-tab="sales">Sales</button>
        </div>

        <!-- Tab: Overview -->
        <div id="tab-overview" class="tab-content">
            <div class="space-y-6">
                <section>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center">
                            <i data-lucide="building-2" class="w-4 h-4 text-red-600"></i>
                        </div>
                        <h2 class="text-base font-bold text-gray-900">High Density Nearby</h2>
                    </div>
                    <div id="critical-alerts" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-2xl"></div>
                    </div>
                </section>
                <section>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center">
                            <i data-lucide="scissors" class="w-4 h-4 text-amber-600"></i>
                        </div>
                        <div>
                            <h2 class="text-base font-bold text-gray-900">Lot Splits &amp; Subdivisions</h2>
                            <p class="text-xs text-gray-500">Projects that increase housing density in your area</p>
                        </div>
                    </div>
                    <div id="lotsplit-overview" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-2xl"></div>
                    </div>
                </section>
                <section>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                            <i data-lucide="map-pin" class="w-4 h-4 text-emerald-600"></i>
                        </div>
                        <h2 class="text-base font-bold text-gray-900">All Nearby (1.5 Miles)</h2>
                    </div>
                    <div id="nearby-overview" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-2xl"></div>
                    </div>
                </section>
                <section>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-4 h-4 text-purple-600"></i>
                        </div>
                        <div>
                            <h2 class="text-base font-bold text-gray-900">Recently Approved</h2>
                            <p class="text-xs text-gray-500">Approved in the last 5 years — may be under construction</p>
                        </div>
                    </div>
                    <div id="approved-overview" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-2xl"></div>
                    </div>
                </section>
                <section>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i data-lucide="dollar-sign" class="w-4 h-4 text-blue-600"></i>
                        </div>
                        <h2 class="text-base font-bold text-gray-900">Recent Sales &amp; LLC Purchases</h2>
                    </div>
                    <div id="sales-overview" class="space-y-3">
                        <div class="loading-shimmer h-16 rounded-2xl"></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Tab: All Rezonings -->
        <div id="tab-rezonings" class="tab-content hidden">
            <div class="mb-4 flex items-center gap-3 flex-wrap">
                <div class="flex gap-2 flex-wrap">
                    <button onclick="filterRezonings('all')" class="filter-btn px-4 py-2 text-sm font-medium rounded-xl bg-emerald-600 text-white shadow-sm" data-filter="all">All Active</button>
                    <button onclick="filterRezonings('high-density')" class="filter-btn px-4 py-2 text-sm font-medium rounded-xl bg-gray-100 text-gray-600" data-filter="high-density">High Density</button>
                    <button onclick="filterRezonings('lotsplit')" class="filter-btn px-4 py-2 text-sm font-medium rounded-xl bg-gray-100 text-gray-600" data-filter="lotsplit">Lot Splits</button>
                    <button onclick="filterRezonings('approved')" class="filter-btn px-4 py-2 text-sm font-medium rounded-xl bg-gray-100 text-gray-600" data-filter="approved">Approved</button>
                </div>
                <div class="text-sm text-gray-500 font-medium" id="rezoning-count">Loading...</div>
            </div>
            <div id="all-rezonings" class="space-y-3">
                <div class="loading-shimmer h-32 rounded-2xl"></div>
            </div>
        </div>

        <!-- Tab: Nearby -->
        <div id="tab-nearby" class="tab-content hidden">
            <div class="mb-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                <p class="text-sm text-emerald-800 font-medium">Showing rezonings &amp; subdivisions within <strong>1.5 miles</strong> of Mammoth Oaks &amp; Lansdowne</p>
                <p class="text-xs text-emerald-600 mt-1">Includes active petitions, approved rezonings, and subdivision plats</p>
            </div>
            <div id="nearby-rezonings" class="space-y-3">
                <div class="loading-shimmer h-32 rounded-2xl"></div>
            </div>
        </div>

        <!-- Tab: Sales -->
        <div id="tab-sales" class="tab-content hidden">
            <div class="mb-5">
                <h2 class="text-lg font-bold text-gray-900 mb-1">Property Sales Lookup</h2>
                <p class="text-sm text-gray-600">Find recent sales in 28270. Look for LLC buyers — they're often developers planning lot splits.</p>
            </div>

            <!-- Quick Search Links -->
            <div class="grid gap-3 mb-5">
                <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,viewport=35.17073:35.09487:-80.76157:-80.86643" target="_blank" class="flex items-center gap-4 p-4 rounded-2xl bg-white border border-gray-200 hover:shadow-md transition-all shadow-sm">
                    <div class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center text-red-600 font-bold text-lg flex-shrink-0">R</div>
                    <div class="min-w-0">
                        <p class="font-semibold text-gray-900">Redfin — Sold Homes</p>
                        <p class="text-sm text-gray-500">Recent sales with photos and prices</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 flex-shrink-0"></i>
                </a>
                <a href="https://www.zillow.com/charlotte-nc-28270/sold/?searchQueryState=%7B%22pagination%22%3A%7B%7D%2C%22usersSearchTerm%22%3A%2228270%22%2C%22mapBounds%22%3A%7B%22north%22%3A35.17%2C%22south%22%3A35.09%2C%22east%22%3A-80.76%2C%22west%22%3A-80.87%7D%2C%22filterState%22%3A%7B%22sort%22%3A%7B%22value%22%3A%22days%22%7D%2C%22ah%22%3A%7B%22value%22%3Atrue%7D%2C%22rs%22%3A%7B%22value%22%3Atrue%7D%2C%22fsba%22%3A%7B%22value%22%3Afalse%7D%2C%22fsbo%22%3A%7B%22value%22%3Afalse%7D%2C%22nc%22%3A%7B%22value%22%3Afalse%7D%2C%22cmsn%22%3A%7B%22value%22%3Afalse%7D%2C%22auc%22%3A%7B%22value%22%3Afalse%7D%2C%22fore%22%3A%7B%22value%22%3Afalse%7D%7D%7D" target="_blank" class="flex items-center gap-4 p-4 rounded-2xl bg-white border border-gray-200 hover:shadow-md transition-all shadow-sm">
                    <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-lg flex-shrink-0">Z</div>
                    <div class="min-w-0">
                        <p class="font-semibold text-gray-900">Zillow — Sold Homes</p>
                        <p class="text-sm text-gray-500">Sale history and neighborhood comparables</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 flex-shrink-0"></i>
                </a>
                <a href="https://meckrod.manatron.com/RealEstate/SearchEntry.aspx" target="_blank" class="flex items-center gap-4 p-4 rounded-2xl bg-white border border-gray-200 hover:shadow-md transition-all shadow-sm">
                    <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center text-emerald-600 font-bold text-sm flex-shrink-0">RoD</div>
                    <div class="min-w-0">
                        <p class="font-semibold text-gray-900">Register of Deeds</p>
                        <p class="text-sm text-gray-500">All deed transfers — find LLC buyers</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 flex-shrink-0"></i>
                </a>
            </div>

            <!-- How to Spot Developers -->
            <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200 mb-5">
                <h3 class="font-bold text-amber-800 mb-2 flex items-center gap-2 text-sm">
                    <i data-lucide="lightbulb" class="w-4 h-4"></i>
                    How to Spot Developer Purchases
                </h3>
                <ul class="text-sm text-amber-900 space-y-1.5">
                    <li class="flex items-start gap-2"><span class="text-amber-500 mt-0.5">•</span> Buyer name contains <strong>LLC, Holdings, Properties, or Trust</strong></li>
                    <li class="flex items-start gap-2"><span class="text-amber-500 mt-0.5">•</span> Cash purchases (no mortgage recorded)</li>
                    <li class="flex items-start gap-2"><span class="text-amber-500 mt-0.5">•</span> Older homes on large lots — prime for lot splits</li>
                    <li class="flex items-start gap-2"><span class="text-amber-500 mt-0.5">•</span> Multiple properties purchased by same buyer</li>
                </ul>
            </div>

            <!-- Street Searches -->
            <div class="mb-5">
                <h3 class="text-sm font-bold text-gray-700 mb-3">Quick Street Searches</h3>
                <div class="flex flex-wrap gap-2 mb-4">
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=mammoth" target="_blank" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-red-300 hover:text-red-600 transition-colors shadow-sm">Mammoth Oaks</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=lansdowne" target="_blank" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-red-300 hover:text-red-600 transition-colors shadow-sm">Lansdowne</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=preston" target="_blank" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-red-300 hover:text-red-600 transition-colors shadow-sm">Preston Ln</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=sharon" target="_blank" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-red-300 hover:text-red-600 transition-colors shadow-sm">Sharon View</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=lansing" target="_blank" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-red-300 hover:text-red-600 transition-colors shadow-sm">Lansing Dr</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=alexander" target="_blank" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-red-300 hover:text-red-600 transition-colors shadow-sm">Alexander Rd</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=sardis" target="_blank" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-red-300 hover:text-red-600 transition-colors shadow-sm">Sardis Rd</a>
                </div>

                <h3 class="text-sm font-bold text-gray-700 mb-2">Deed Searches — Register of Deeds</h3>
                <p class="text-xs text-gray-500 mb-2">Search deed transfers to find LLC buyers in your area</p>
                <div class="flex flex-wrap gap-2">
                    <a href="https://meckrod.manatron.com/RealEstate/SearchEntry.aspx" target="_blank" class="px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-700 hover:bg-emerald-100 transition-colors" title="Search deeds — try &quot;Mammoth Oaks&quot;">Mammoth Oaks</a>
                    <a href="https://meckrod.manatron.com/RealEstate/SearchEntry.aspx" target="_blank" class="px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-700 hover:bg-emerald-100 transition-colors" title="Search deeds — try &quot;Lansdowne&quot;">Lansdowne</a>
                    <a href="https://meckrod.manatron.com/RealEstate/SearchEntry.aspx" target="_blank" class="px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-700 hover:bg-emerald-100 transition-colors" title="Search deeds — try &quot;Preston&quot;">Preston Ln</a>
                    <a href="https://meckrod.manatron.com/RealEstate/SearchEntry.aspx" target="_blank" class="px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-700 hover:bg-emerald-100 transition-colors" title="Search deeds — try &quot;Sharon View&quot;">Sharon View</a>
                    <a href="https://meckrod.manatron.com/RealEstate/SearchEntry.aspx" target="_blank" class="px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-700 hover:bg-emerald-100 transition-colors" title="Search deeds — try &quot;Alexander&quot;">Alexander Rd</a>
                </div>
            </div>

            <!-- Watched Developers -->
            <div class="mb-5 p-4 rounded-2xl bg-purple-50 border border-purple-200">
                <h3 class="font-bold text-purple-800 mb-2 flex items-center gap-2 text-sm">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    Watched Developer Deed Searches
                </h3>
                <p class="text-xs text-purple-600 mb-3">Search Register of Deeds for these developers' recent transactions:</p>
                <div class="flex flex-wrap gap-2" id="watched-dev-links"></div>
            </div>

            <!-- Cached Sales Data -->
            <div class="border-t border-gray-200 pt-5">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-sm font-bold text-gray-700">Active Listings (28270)</h3>
                        <p class="text-xs text-gray-500 mt-0.5" id="sales-source">Homes for sale from RentCast</p>
                    </div>
<div class="flex gap-2 flex-wrap items-center">
                            <button onclick="filterSales('all')" class="sales-filter-btn px-3 py-1.5 text-xs font-medium rounded-xl bg-emerald-600 text-white" data-sales-filter="all">All</button>
                            <button onclick="filterSales('llc')" class="sales-filter-btn px-3 py-1.5 text-xs font-medium rounded-xl bg-gray-100 text-gray-600" data-sales-filter="llc">New Builds</button>
                            <button onclick="refreshSalesOnly()" class="px-3 py-1.5 text-xs font-medium rounded-xl bg-white border border-gray-300 text-gray-600 hover:bg-gray-50" title="Reload listings from RentCast">Refresh</button>
                        </div>
                </div>
                <div class="overflow-x-auto rounded-2xl border border-gray-200 shadow-sm">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500">ADDRESS</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500">AGENT</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500">PRICE</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500">LISTED</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 hidden sm:table-cell">BEDS/BATHS</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500">TYPE</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table" class="divide-y divide-gray-100">
                            <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">Loading sales data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-xs text-gray-400" id="sales-count">0 sales</div>
            </div>
        </div>
    </main>

    <footer class="border-t border-gray-200 mt-12 py-6 bg-white">
        <div class="max-w-3xl mx-auto px-4 text-center text-xs text-gray-400">
            Data from Charlotte Planning ArcGIS &bull; Mecklenburg County POLARIS &bull; Updated automatically
            <span class="mx-2">|</span><a href="mailto:?subject=Mammoth%20Oaks%20Tracker%20Feedback" class="text-emerald-600 hover:underline">Feedback / comments</a>
        </div>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const NEIGHBORHOOD_CENTER = { lat: 35.1328, lon: -80.8140 };
        const SEARCH_RADIUS_MILES = 1.5; // Focused on Mammoth Oaks & Lansdowne area
        const ZIP_CODE = '28270';

        // APIs
        const REZONING_API = 'https://gis.charlottenc.gov/arcgis/rest/services/PLN/Rezonings/MapServer/0/query';
        const REZONING_HISTORY_API = 'https://gis.charlottenc.gov/arcgis/rest/services/PLN/RezoningHistory/MapServer/0/query';
        const ADDRESS_API = 'https://gis.charlottenc.gov/arcgis/rest/services/CountyData/MasterAddress/MapServer/0/query';
        const SUBDIVISION_API = 'https://gis.charlottenc.gov/arcgis/rest/services/PLN/Subdivisions/MapServer/0/query';

        // Keywords
        const HIGH_DENSITY = ['townhome', 'townhouse', 'multi-family', 'multifamily', 'attached', 'N2-A', 'N2-B', 'UR-2', 'UR-3', 'apartment', 'condo', 'duplex', 'triplex', 'MF', 'TOD', 'MUDD'];
        const LOTSPLIT = ['N1-C', 'N1-D', 'N1-E', 'subdivision', 'split', 'two lot', '2 lot', 'minor subdivision', 'infill', 'cottage', 'small lot'];

        function isDensityIncrease(fromZone, toZone) {
            if (!fromZone || !toZone) return false;
            const from = fromZone.toUpperCase().replace(/\(CD\)|\(SPA\)|\(LLWPA\)/g, '').trim();
            const to = toZone.toUpperCase().replace(/\(CD\)|\(SPA\)|\(LLWPA\)/g, '').trim();
            const fromR = from.match(/^R-(\d+)/);
            if (fromR && /^N1-[CDE]/.test(to)) return true;
            if (fromR && /^(N2-|UR-|MX-|TOD|MUDD)/.test(to)) return true;
            const toR = to.match(/^R-(\d+)/);
            if (fromR && toR) {
                return parseInt(toR[1]) > parseInt(fromR[1]);
            }
            return false;
        }

        const WATCHED_DEVS = ['Veer Homes', 'THR Design', 'THR Build', 'THR Holdings', 'Pike Properties', 'Northway', 'Sinacori', 'Epic Homes', 'Forte Builders', 'DR Horton', 'Lennar', 'Pulte', 'Meritage'];
        const LLC_PATTERNS = ['LLC', 'L.L.C.', 'LP', 'L.P.', 'INC', 'CORP', 'HOLDINGS', 'INVESTMENTS', 'DEVELOPMENT', 'PROPERTIES', 'VENTURES', 'CAPITAL', 'PARTNERS', 'GROUP', 'TRUST'];

        const API_KEY_STORAGE = 'mammoth_oaks_api_key';
        const SALES_CACHE = 'mammoth_oaks_sales_cache';
        const ADDRESS_CACHE = 'mammoth_oaks_address_cache';
        const DEFAULT_RENTCAST_KEY = '8b894ad1348e4918ae3443328dadc07a';

        let allRezonings = [];
        let nearbyRezonings = [];
        let approvedRezonings = [];
        let nearbyApproved = [];
        let allSubdivisions = [];
        let nearbySubdivisions = [];
        let allSales = [];
        let addressCache = {};
        let currentFilter = 'all';
        let currentSalesFilter = 'all';

        // ============================================
        // ZONING TRANSLATOR
        // ============================================
        function getZoningDescription(code) {
            if (!code || code === '-') return 'Unknown';
            const c = code.toUpperCase().replace(/\(CD\)|\(SPA\)|\(LLWPA\)/g, '').trim();
            if (/^R-3|^R-4|^R-5|^R-6|^R-8|^R-MH/.test(c)) return 'Single-family homes';
            if (/^N1-A|^N1-B/.test(c)) return 'Single-family homes';
            if (/^RE-1|^RE-2|^RE-3/.test(c)) return 'Large lot single-family';
            if (/^N1-C/.test(c)) return 'Lot splits allowed (2-3 homes per lot)';
            if (/^N1-D|^N1-E/.test(c)) return 'Small lot single-family or duplexes';
            if (/^N2-A/.test(c)) return 'Townhomes & duplexes (8-12 units/acre)';
            if (/^N2-B/.test(c)) return 'Townhomes & triplexes (12-17 units/acre)';
            if (/^UR-1/.test(c)) return 'Urban residential (8-12 units/acre)';
            if (/^UR-2/.test(c)) return 'Apartments & condos (12-18 units/acre)';
            if (/^UR-3/.test(c)) return 'High-rise apartments (18-22+ units/acre)';
            if (/^MF/.test(c)) return 'Multi-family apartments';
            if (/^TOD/.test(c)) return 'Transit-oriented (apartments + retail)';
            if (/^MUDD/.test(c)) return 'Mixed-use (apartments + commercial)';
            if (/^MX/.test(c)) return 'Mixed-use development';
            if (/^CC/.test(c)) return 'Commercial center';
            if (/^TS/.test(c)) return 'Transit station area';
            if (/^B-1|^B-2|^NS|^O-1|^O-2/.test(c)) return 'Commercial/Office';
            if (/^I-1|^I-2/.test(c)) return 'Industrial';
            if (/^INST/.test(c)) return 'Institutional';
            if (/^R-17MF|^R-22MF|^R-43MF/.test(c)) return 'Multi-family apartments';
            if (/^R-12MF/.test(c)) return 'Townhomes/apartments';
            return code;
        }

        function getZoningChangeDescription(fromZone, toZone) {
            const from = getZoningDescription(fromZone);
            const to = getZoningDescription(toZone);
            if (from === to) return null;
            return `${from} → ${to}`;
        }

        // ============================================
        // RELIABLE LINK HELPERS (always work, never 404)
        // ============================================
        function getSearchUrl(petition) {
            // Google search for this specific petition — always loads, finds Charlotte pages + news + community posts
            if (!petition || petition === 'Unknown') return null;
            return `https://www.google.com/search?q=Charlotte+NC+rezoning+petition+${encodeURIComponent(petition)}`;
        }

        function getMapUrl(lat, lon) {
            if (!lat || !lon) return null;
            return `https://www.google.com/maps/@${lat},${lon},17z/data=!3m1!1e3`;
        }

        // ============================================
        // API FUNCTIONS
        // ============================================
        async function fetchRezonings() {
            const params = new URLSearchParams({ where: '1=1', outFields: '*', f: 'json', returnGeometry: 'true', outSR: '4326' });
            const response = await fetch(`${REZONING_API}?${params}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.features || [];
        }

        async function fetchApprovedRezonings() {
            const fiveYearsAgo = new Date(Date.now() - (1825 * 24 * 60 * 60 * 1000));
            const dateStr = fiveYearsAgo.toISOString().split('T')[0];
            const params = new URLSearchParams({
                where: `Status = 'App' AND Approved >= DATE '${dateStr}'`,
                outFields: '*', f: 'json', returnGeometry: 'true', outSR: '4326'
            });
            try {
                const response = await fetch(`${REZONING_HISTORY_API}?${params}`);
                if (!response.ok) return [];
                const data = await response.json();
                if (data.error) return [];
                return data.features || [];
            } catch (e) { console.error('Error fetching approved:', e); return []; }
        }

        async function fetchSubdivisions() {
            const buffer = 0.045;
            try {
                const params = new URLSearchParams({
                    where: '1=1',
                    geometry: JSON.stringify({ xmin: NEIGHBORHOOD_CENTER.lon - buffer, ymin: NEIGHBORHOOD_CENTER.lat - buffer, xmax: NEIGHBORHOOD_CENTER.lon + buffer, ymax: NEIGHBORHOOD_CENTER.lat + buffer, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryEnvelope', spatialRel: 'esriSpatialRelIntersects',
                    outFields: 'ProjName,Address,Developer,PlanType,Zoning,SFLots,MFUnits,UnitType,AppStatus,SubmitDate,StatusDate,RezonPetit,AcreSF,AcreMF',
                    returnGeometry: 'true', outSR: '4326', f: 'json', resultRecordCount: '200'
                });
                const response = await fetch(`${SUBDIVISION_API}?${params}`);
                if (!response.ok) return [];
                const data = await response.json();
                if (data.error) return [];
                return data.features || [];
            } catch (e) { console.error('Error fetching subdivisions:', e); return []; }
        }

        function processSubdivisions(features) {
            const results = [];
            for (const f of features) {
                try {
                    const a = f.attributes, geom = f.geometry;
                    let lat = null, lon = null;
                    if (geom && geom.rings && geom.rings[0] && geom.rings[0].length > 0) {
                        const ring = geom.rings[0];
                        lon = ring.reduce((sum, pt) => sum + pt[0], 0) / ring.length;
                        lat = ring.reduce((sum, pt) => sum + pt[1], 0) / ring.length;
                    } else if (geom && geom.x != null && geom.y != null) { lon = geom.x; lat = geom.y; }
                    if (!lat || !lon || isNaN(lat) || isNaN(lon)) continue;
                    const planType = (a.PlanType || '').toLowerCase(), unitType = (a.UnitType || '').toLowerCase();
                    const developer = a.Developer || '', sfLots = a.SFLots || 0, mfUnits = a.MFUnits || 0;
                    const totalUnits = sfLots + mfUnits, acres = (a.AcreSF || 0) + (a.AcreMF || 0);
                    const status = a.AppStatus || '';
                    if (status.toLowerCase().includes('withdrawn')) continue;
                    let type = 'other';
                    if (planType.includes('multi') || planType.includes('apartment') || unitType.includes('townhome') || unitType.includes('townhouse') || unitType.includes('apartment') || unitType.includes('condo') || mfUnits > 0) { type = 'high-density'; }
                    else if (planType.includes('single') && sfLots >= 2) { type = 'lotsplit'; }
                    else if (planType.includes('subdivision') || planType.includes('urban')) { type = 'lotsplit'; }
                    const isWatched = WATCHED_DEVS.some(dev => developer.toLowerCase().includes(dev.toLowerCase()));
                    let description = '';
                    if (sfLots > 0 && mfUnits > 0) description = `${sfLots} single-family lots + ${mfUnits} multi-family units`;
                    else if (sfLots > 0) description = `${sfLots} single-family lot${sfLots > 1 ? 's' : ''}`;
                    else if (mfUnits > 0) description = `${mfUnits} ${unitType || 'multi-family'} unit${mfUnits > 1 ? 's' : ''}`;
                    if (acres > 0) description += ` on ${acres.toFixed(1)} acres`;
                    if (a.Zoning) description += ` (${a.Zoning})`;
                    const distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, lat, lon);
                    results.push({
                        id: `SUB-${a.OBJECTID || results.length}`, name: a.ProjName || 'Unnamed Subdivision',
                        address: a.Address || null, developer, planType: a.PlanType || '', zoning: a.Zoning || '',
                        sfLots, mfUnits, totalUnits, unitType: a.UnitType || '', status, rezoningPetition: a.RezonPetit || '',
                        acres, type, isWatched, isSubdivision: true, lat, lon, distance, description,
                        submitDate: a.SubmitDate ? new Date(a.SubmitDate).toLocaleDateString() : null,
                        statusDate: a.StatusDate ? new Date(a.StatusDate).toLocaleDateString() : null
                    });
                } catch (e) { console.error('Error processing subdivision:', e, f); }
            }
            return results.sort((a, b) => (a.distance || 999) - (b.distance || 999));
        }

        async function processApprovedRezonings(features) {
            const results = [];
            for (const f of features) {
                const a = f.attributes, geom = f.geometry;
                let lat = null, lon = null;
                if (geom && geom.rings && geom.rings[0]) { const ring = geom.rings[0]; lon = ring.reduce((sum, pt) => sum + pt[0], 0) / ring.length; lat = ring.reduce((sum, pt) => sum + pt[1], 0) / ring.length; }
                const existZone = a.ExistingZoning || a.ExistZone || '-', reqZone = a.RequestedZoning || a.ReqZone || '-', propLuse = a.Propluse || '';
                const allText = `${existZone} ${reqZone} ${propLuse} ${a.Petitioner || ''}`.toLowerCase();
                let type = 'other';
                if (HIGH_DENSITY.some(kw => allText.includes(kw.toLowerCase()))) type = 'high-density';
                else if (LOTSPLIT.some(kw => allText.includes(kw.toLowerCase())) || isDensityIncrease(existZone, reqZone)) type = 'lotsplit';
                const petitioner = a.Petitioner || '';
                const isWatched = WATCHED_DEVS.some(dev => petitioner.toLowerCase().includes(dev.toLowerCase()));
                let description = `Rezoned from ${existZone} to ${reqZone}`;
                if (propLuse) description += ` for ${propLuse}`;
                let approvedDate = a.Approved ? new Date(a.Approved).toLocaleDateString() : null;
                results.push({ id: a.Petition || a.OBJECTID, petition: a.Petition || 'Unknown', petitioner: petitioner || 'Unknown', currentZoning: existZone, proposedZoning: reqZone, proposedUse: propLuse, status: 'Approved', description, approvedDate, acres: a.Acres || a.PetAcres || null, type, isWatched, isApproved: true, lat, lon, address: null });
            }
            return results;
        }

        async function lookupAddress(lat, lon) {
            const cacheKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;
            if (addressCache[cacheKey]) return addressCache[cacheKey];
            try {
                const buffer = 0.002;
                const params = new URLSearchParams({
                    where: '1=1', geometry: JSON.stringify({ xmin: lon - buffer, ymin: lat - buffer, xmax: lon + buffer, ymax: lat + buffer, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryEnvelope', spatialRel: 'esriSpatialRelIntersects',
                    outFields: 'FullAddress,ZipCode', returnGeometry: 'false', f: 'json', resultRecordCount: 1
                });
                const response = await fetch(`${ADDRESS_API}?${params}`);
                if (!response.ok) return null;
                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    const addr = data.features[0].attributes.FullAddress;
                    addressCache[cacheKey] = addr;
                    localStorage.setItem(ADDRESS_CACHE, JSON.stringify(addressCache));
                    return addr;
                }
            } catch (e) { console.error('Address lookup error:', e); }
            return null;
        }

        async function fetchSalesData(forceRefresh) {
            if (forceRefresh) try { localStorage.removeItem(SALES_CACHE); } catch (e) {}
            const apiKey = localStorage.getItem(API_KEY_STORAGE) || DEFAULT_RENTCAST_KEY;
            let cached = null;
            try { const raw = localStorage.getItem(SALES_CACHE); if (raw) cached = JSON.parse(raw); } catch (e) {}
            if (!forceRefresh && cached && cached.sales && cached.sales.length > 0 && Date.now() - cached.timestamp < 86400000) return cached.sales;
            if (apiKey) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 12000);
                    // Use /listings/sale endpoint - returns active sale listings with prices
                    const response = await fetch(`https://api.rentcast.io/v1/listings/sale?zipCode=${ZIP_CODE}&limit=50&status=Active`, { headers: { 'X-Api-Key': apiKey }, signal: controller.signal });
                    clearTimeout(timeoutId);
                    const data = await response.json().catch(() => null);
                    if (!response.ok) {
                        console.warn('RentCast API:', response.status, data || response.statusText);
                        if (cached && cached.sales && cached.sales.length > 0) return cached.sales;
                        return [];
                    }
                    const rawList = Array.isArray(data) ? data : (data && (data.listings || data.properties || data.data || data.results));
                    if (rawList && Array.isArray(rawList) && rawList.length > 0) {
                        const sales = rawList
                            .filter(p => p && p.price)
                            .map(p => {
                                const addr = p.formattedAddress || p.addressLine1 || '';
                                const price = p.price;
                                const date = p.listedDate ? new Date(p.listedDate).toLocaleDateString() : 'Unknown';
                                const agent = p.listingAgent?.name || '';
                                const listingType = p.listingType || '';
                                return {
                                    address: addr, price: price != null ? `$${Number(price).toLocaleString()}` : 'N/A',
                                    priceNum: price != null ? Number(price) : 0, date, beds: p.bedrooms || '-', baths: p.bathrooms || '-',
                                    sqft: p.squareFootage ? Number(p.squareFootage).toLocaleString() : '-', buyer: agent,
                                    isLLC: listingType === 'New Construction' || LLC_PATTERNS.some(pat => addr.toUpperCase().includes(pat)),
                                    isWatched: listingType === 'New Construction',
                                    listingType,
                                    source: 'RentCast'
                                };
                            })
                            .sort((a, b) => b.priceNum - a.priceNum);
                        if (sales.length > 0) { try { localStorage.setItem(SALES_CACHE, JSON.stringify({ timestamp: Date.now(), sales })); } catch (e) {} return sales; }
                    }
                } catch (e) { console.error('RentCast error:', e); }
            }
            if (cached && cached.sales && cached.sales.length > 0) return cached.sales;
            return [];
        }

        async function refreshSalesOnly() {
            const tbody = document.getElementById('sales-table');
            if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">Refreshing sales...</td></tr>';
            try { allSales = await fetchSalesData(true); } catch (e) { allSales = []; }
            renderSales();
        }

        // ============================================
        // DATA PROCESSING
        // ============================================
        async function processRezonings(features) {
            const results = [];
            for (const f of features) {
                const a = f.attributes, geom = f.geometry;
                let lat = null, lon = null;
                if (geom && geom.rings && geom.rings[0]) { const ring = geom.rings[0]; lon = ring.reduce((sum, pt) => sum + pt[0], 0) / ring.length; lat = ring.reduce((sum, pt) => sum + pt[1], 0) / ring.length; }
                const existZone = a.ExistZone || '-', reqZone = a.ReqZone || '-', propLuse = a.Propluse || '';
                const allText = `${existZone} ${reqZone} ${propLuse} ${a.Petitioner || ''}`.toLowerCase();
                let type = 'other';
                if (HIGH_DENSITY.some(kw => allText.includes(kw.toLowerCase()))) type = 'high-density';
                else if (LOTSPLIT.some(kw => allText.includes(kw.toLowerCase())) || isDensityIncrease(existZone, reqZone)) type = 'lotsplit';
                const petitioner = a.Petitioner || '';
                const isWatched = WATCHED_DEVS.some(dev => petitioner.toLowerCase().includes(dev.toLowerCase()));
                let description = `Rezone from ${existZone} to ${reqZone}`;
                if (propLuse) description += ` for ${propLuse}`;
                let hearingDate = null;
                if (a.HearingDate) hearingDate = new Date(a.HearingDate).toLocaleDateString();
                else if (a.Hearing_Date) hearingDate = new Date(a.Hearing_Date).toLocaleDateString();
                else if (a.ZoningDate) hearingDate = new Date(a.ZoningDate).toLocaleDateString();
                results.push({ id: a.Petition || a.OBJECTID, petition: a.Petition || 'Unknown', petitioner: petitioner || 'Unknown', currentZoning: existZone, proposedZoning: reqZone, proposedUse: propLuse, status: a.Status || 'Pending', description, filedDate: a.Received ? new Date(a.Received).toLocaleDateString() : null, hearingDate, acres: a.Acres || a.PetAcres || null, type, isWatched, lat, lon, address: null });
            }
            return results;
        }

        async function enrichWithAddresses(rezonings) {
            const cached = localStorage.getItem(ADDRESS_CACHE);
            if (cached) addressCache = JSON.parse(cached);
            rezonings.forEach(r => { if (r.lat && r.lon) r.distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, r.lat, r.lon); });
            const needsLookup = rezonings.filter(r => !r.address && r.lat && r.lon);
            const batchSize = 10;
            for (let i = 0; i < Math.min(needsLookup.length, 50); i += batchSize) {
                const batch = needsLookup.slice(i, i + batchSize);
                await Promise.all(batch.map(async r => { r.address = await lookupAddress(r.lat, r.lon); }));
            }
            return rezonings;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function filterNearby(rezonings) {
            return rezonings.filter(r => {
                if (!r.lat || !r.lon) return false;
                if (!r.distance) r.distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, r.lat, r.lon);
                return r.distance <= SEARCH_RADIUS_MILES;
            }).sort((a, b) => a.distance - b.distance);
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function showError(message) { document.getElementById('error-banner').classList.remove('hidden'); document.getElementById('error-message').textContent = message; }
        function hideError() { document.getElementById('error-banner').classList.add('hidden'); }

        function renderRezoningCard(r, showDistance = false) {
            const cardClass = r.isApproved ? 'card-ap' : (r.type === 'high-density' ? 'card-hd' : (r.type === 'lotsplit' ? 'card-ls' : 'card-default'));
            const bgClass = r.isApproved ? 'bg-purple-50' : (r.type === 'high-density' ? 'bg-red-50' : (r.type === 'lotsplit' ? 'bg-amber-50' : 'bg-white'));

            const typeBadge = r.type === 'high-density' ? '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-lg">High Density</span>' :
                             r.type === 'lotsplit' ? '<span class="px-2 py-1 text-xs font-semibold bg-amber-100 text-amber-700 rounded-lg">Lot Split</span>' : '';
            const watchedBadge = r.isWatched ? '<span class="px-2 py-1 text-xs font-semibold bg-purple-100 text-purple-700 rounded-lg">Watched</span>' : '';
            const approvedBadge = r.isApproved ? '<span class="px-2 py-1 text-xs font-semibold bg-purple-100 text-purple-700 rounded-lg">Approved</span>' : '';
            const distanceText = showDistance && r.distance ? `<span class="text-sm font-semibold text-emerald-600">${r.distance.toFixed(1)} mi</span>` : '';

            const addressDisplay = r.address
                ? `<p class="font-semibold text-gray-900 text-sm">${r.address}</p>`
                : `<p class="text-gray-400 text-sm">Location: see petition details</p>`;

            const plainChange = getZoningChangeDescription(r.currentZoning, r.proposedZoning);
            const plainChangeHtml = plainChange
                ? `<div class="mt-2 p-2.5 rounded-xl bg-white/80 border border-gray-200">
                       <p class="text-xs text-gray-500 mb-0.5 font-medium">WHAT THIS MEANS</p>
                       <p class="text-sm font-semibold text-gray-900">${plainChange}</p>
                   </div>` : '';

            return `
                <div class="p-4 rounded-2xl ${bgClass} ${cardClass} border border-gray-200 shadow-sm">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1.5">
                                <span class="font-bold text-gray-900 text-sm">Petition ${r.petition}</span>
                                ${typeBadge} ${watchedBadge} ${approvedBadge}
                                ${!r.isApproved ? `<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-lg">${r.status}</span>` : ''}
                                ${distanceText}
                            </div>
                            ${addressDisplay}
                            ${plainChangeHtml}
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-500 mt-3">
                                <div>Petitioner: <span class="text-gray-700 font-medium">${r.petitioner}</span></div>
                                <div>Acres: <span class="text-gray-700">${r.acres || '-'}</span></div>
                                <div>Current: <span class="text-gray-700">${r.currentZoning}</span></div>
                                <div>Proposed: <span class="text-gray-900 font-semibold">${r.proposedZoning}</span></div>
                                ${r.filedDate ? `<div>Filed: <span class="text-gray-700">${r.filedDate}</span></div>` : ''}
                                ${r.hearingDate ? `<div>Hearing: <span class="text-red-600 font-semibold">${r.hearingDate}</span></div>` : ''}
                                ${r.approvedDate ? `<div>Approved: <span class="text-purple-600 font-semibold">${r.approvedDate}</span></div>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 flex-shrink-0">
                            ${getSearchUrl(r.petition) ? `<a href="${getSearchUrl(r.petition)}" target="_blank" class="flex items-center gap-1.5 px-3 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl transition-colors text-xs font-bold whitespace-nowrap shadow-sm">More Info <i data-lucide="search" class="w-3.5 h-3.5"></i></a>` : ''}
                            ${getMapUrl(r.lat, r.lon) ? `<a href="${getMapUrl(r.lat, r.lon)}" target="_blank" class="flex items-center gap-1.5 px-3 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded-xl transition-colors text-xs font-medium text-gray-700 whitespace-nowrap">Map <i data-lucide="map-pin" class="w-3 h-3"></i></a>` : ''}
                        </div>
                    </div>
                </div>`;
        }

        function renderSubdivisionCard(s) {
            if (!s) return '';
            const cardClass = s.type === 'high-density' ? 'card-hd' : (s.type === 'lotsplit' ? 'card-ls' : 'card-sub');
            const bgClass = s.type === 'high-density' ? 'bg-red-50' : (s.type === 'lotsplit' ? 'bg-amber-50' : 'bg-cyan-50');
            const typeBadge = s.type === 'high-density' ? '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-lg">High Density</span>' :
                             s.type === 'lotsplit' ? '<span class="px-2 py-1 text-xs font-semibold bg-amber-100 text-amber-700 rounded-lg">Lot Split</span>' : '';
            const watchedBadge = s.isWatched ? '<span class="px-2 py-1 text-xs font-semibold bg-purple-100 text-purple-700 rounded-lg">Watched</span>' : '';
            const distanceText = s.distance ? `<span class="text-sm font-semibold text-emerald-600">${s.distance.toFixed(1)} mi</span>` : '';
            let unitSummary = '';
            if (s.sfLots > 0 && s.mfUnits > 0) unitSummary = `<span class="text-amber-700 font-medium">${s.sfLots} SF lots</span> + <span class="text-red-700 font-medium">${s.mfUnits} MF units</span>`;
            else if (s.sfLots > 0) unitSummary = `<span class="text-amber-700 font-medium">${s.sfLots} single-family lot${s.sfLots > 1 ? 's' : ''}</span>`;
            else if (s.mfUnits > 0) unitSummary = `<span class="text-red-700 font-medium">${s.mfUnits} ${s.unitType || 'multi-family'} unit${s.mfUnits > 1 ? 's' : ''}</span>`;
            const addressDisplay = s.address && s.address !== '0' && !s.address.startsWith('0 ')
                ? `<p class="font-semibold text-gray-900 text-sm">${s.address}</p>`
                : `<p class="text-gray-400 text-sm">Location: see map</p>`;
            const searchUrl = s.rezoningPetition && s.rezoningPetition !== 'N/A' ? getSearchUrl(s.rezoningPetition) : null;

            return `
                <div class="p-4 rounded-2xl ${bgClass} ${cardClass} border border-gray-200 shadow-sm">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1.5">
                                <span class="font-bold text-gray-900 text-sm">${s.name}</span>
                                <span class="px-2 py-1 text-xs font-semibold bg-cyan-100 text-cyan-700 rounded-lg">Subdivision</span>
                                ${typeBadge} ${watchedBadge}
                                ${s.status ? `<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-lg">${s.status}</span>` : ''}
                                ${distanceText}
                            </div>
                            ${addressDisplay}
                            ${unitSummary ? `<p class="mt-1 text-sm">${unitSummary}</p>` : ''}
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-500 mt-3">
                                <div>Developer: <span class="text-gray-700 font-medium">${s.developer}</span></div>
                                <div>Plan: <span class="text-gray-700">${s.planType || '-'}</span></div>
                                <div>Zoning: <span class="text-gray-700">${s.zoning || '-'}</span></div>
                                <div>Acres: <span class="text-gray-700">${s.acres > 0 ? s.acres.toFixed(1) : '-'}</span></div>
                                ${s.rezoningPetition ? `<div>Rezoning: <span class="text-amber-700 font-medium">${s.rezoningPetition}</span></div>` : ''}
                                ${s.statusDate ? `<div>Updated: <span class="text-gray-700">${s.statusDate}</span></div>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 flex-shrink-0">
                            ${searchUrl ? `<a href="${searchUrl}" target="_blank" class="flex items-center gap-1.5 px-3 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl transition-colors text-xs font-bold whitespace-nowrap shadow-sm">More Info <i data-lucide="search" class="w-3.5 h-3.5"></i></a>` : ''}
                            ${getMapUrl(s.lat, s.lon) ? `<a href="${getMapUrl(s.lat, s.lon)}" target="_blank" class="flex items-center gap-1.5 px-3 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded-xl transition-colors text-xs font-medium text-gray-700 whitespace-nowrap">Map <i data-lucide="map-pin" class="w-3 h-3"></i></a>` : ''}
                        </div>
                    </div>
                </div>`;
        }

        function renderOverview() {
            const criticalNearby = nearbyRezonings.filter(r => r.type === 'high-density');
            const hdSubdivisions = nearbySubdivisions.filter(s => s.type === 'high-density');
            const allHighDensity = [...criticalNearby.map(r => ({ ...r, _render: 'rezoning' })), ...hdSubdivisions.map(s => ({ ...s, _render: 'subdivision' }))].sort((a, b) => (a.distance || 999) - (b.distance || 999));

            document.getElementById('critical-alerts').innerHTML = allHighDensity.length > 0 ?
                allHighDensity.map(item => item._render === 'subdivision' ? renderSubdivisionCard(item) : renderRezoningCard(item, true)).join('') :
                '<p class="text-gray-500 text-sm p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">No high-density projects within 1.5 miles — great news!</p>';

            const lotSplitRezonings = nearbyRezonings.filter(r => r.type === 'lotsplit');
            const lotSplitSubs = nearbySubdivisions.filter(s => s.type === 'lotsplit');
            const allLotSplits = [...lotSplitRezonings.map(r => ({ ...r, _render: 'rezoning' })), ...lotSplitSubs.map(s => ({ ...s, _render: 'subdivision' }))].sort((a, b) => (a.distance || 999) - (b.distance || 999));

            document.getElementById('lotsplit-overview').innerHTML = allLotSplits.length > 0 ?
                allLotSplits.map(item => item._render === 'subdivision' ? renderSubdivisionCard(item) : renderRezoningCard(item, true)).join('') :
                '<p class="text-gray-500 text-sm p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">No lot splits within 1.5 miles</p>';

            document.getElementById('nearby-overview').innerHTML = nearbyRezonings.length > 0 ?
                nearbyRezonings.slice(0, 10).map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-gray-500 text-sm p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">No rezonings within 1.5 miles</p>';

            document.getElementById('approved-overview').innerHTML = nearbyApproved.length > 0 ?
                nearbyApproved.slice(0, 5).map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-gray-500 text-sm p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">No recently approved rezonings nearby</p>';

            const llcSales = allSales.filter(s => s.isLLC).slice(0, 5);
            document.getElementById('sales-overview').innerHTML = llcSales.length > 0 ?
                llcSales.map(s => `
                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-2xl flex justify-between items-center shadow-sm">
                        <div>
                            <p class="font-semibold text-sm text-gray-900">${s.address}</p>
                            <p class="text-xs text-gray-500">${s.price} &bull; ${s.date}</p>
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold bg-amber-100 text-amber-700 rounded-lg">LLC</span>
                    </div>`).join('') :
                `<div class="p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">
                    <p class="text-gray-600 text-sm mb-3">Track LLC purchases and developer activity:</p>
                    <div class="flex flex-wrap gap-2">
                        <a href="https://meckrod.manatron.com/RealEstate/SearchEntry.aspx" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-xl text-xs font-medium hover:bg-emerald-100">Register of Deeds</a>
                        <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-2 bg-red-50 text-red-700 border border-red-200 rounded-xl text-xs font-medium hover:bg-red-100">Redfin</a>
                        <a href="https://polaris3g.mecklenburgcountync.gov/" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-xl text-xs font-medium hover:bg-blue-100">POLARIS</a>
                    </div>
                    <p class="text-gray-400 text-xs mt-3">Tip: Search your street in Register of Deeds, look for LLC or Holdings in the buyer name</p>
                </div>`;

            document.getElementById('stat-critical').textContent = allHighDensity.length;
            document.getElementById('stat-lotsplits').textContent = allLotSplits.length;
            document.getElementById('stat-approved').textContent = nearbyApproved.length;
            document.getElementById('stat-nearby').textContent = nearbyRezonings.length + nearbySubdivisions.length;
            document.getElementById('stat-rezonings').textContent = allRezonings.length;
            document.getElementById('stat-sales').textContent = allSales.length || 'View →';

            const alertCount = allHighDensity.length + nearbyRezonings.filter(r => r.isWatched).length + nearbySubdivisions.filter(s => s.isWatched).length;
            if (alertCount > 0) {
                document.getElementById('alert-banner').classList.remove('hidden');
                document.getElementById('alert-count').textContent = `${alertCount} development projects need your attention`;
            } else {
                document.getElementById('alert-banner').classList.add('hidden');
            }
            lucide.createIcons();
        }

        function renderAllRezonings() {
            let filtered = allRezonings, total = allRezonings.length, countLabel = 'active petitions', includeSubdivisions = false;
            if (currentFilter === 'high-density') filtered = allRezonings.filter(r => r.type === 'high-density');
            else if (currentFilter === 'lotsplit') { filtered = allRezonings.filter(r => r.type === 'lotsplit'); includeSubdivisions = true; }
            else if (currentFilter === 'approved') { filtered = approvedRezonings; total = approvedRezonings.length; countLabel = 'approved (last 5 years)'; }

            let html = '';
            if (includeSubdivisions) {
                const lotSplitSubs = allSubdivisions.filter(s => s.type === 'lotsplit');
                const allItems = [...filtered.map(r => ({ ...r, _render: 'rezoning' })), ...lotSplitSubs.map(s => ({ ...s, _render: 'subdivision' }))].sort((a, b) => (a.distance || 999) - (b.distance || 999));
                document.getElementById('rezoning-count').textContent = `${filtered.length} petitions + ${lotSplitSubs.length} subdivision plats`;
                html = allItems.length > 0 ? allItems.slice(0, 50).map(item => item._render === 'subdivision' ? renderSubdivisionCard(item) : renderRezoningCard(item)).join('') : '<p class="text-gray-500 text-sm p-4">No lot splits found</p>';
            } else {
                document.getElementById('rezoning-count').textContent = `${filtered.length} ${countLabel}`;
                html = filtered.length > 0 ? filtered.slice(0, 50).map(r => renderRezoningCard(r)).join('') : '<p class="text-gray-500 text-sm p-4">No rezonings match filter</p>';
            }
            document.getElementById('all-rezonings').innerHTML = html;
            lucide.createIcons();
        }

        function renderNearbyRezonings() {
            const combined = [...nearbyRezonings.map(r => ({ ...r, _render: 'rezoning' })), ...nearbySubdivisions.map(s => ({ ...s, _render: 'subdivision' }))].sort((a, b) => (a.distance || 999) - (b.distance || 999));
            document.getElementById('nearby-rezonings').innerHTML = combined.length > 0 ?
                combined.map(item => item._render === 'subdivision' ? renderSubdivisionCard(item) : renderRezoningCard(item, true)).join('') :
                '<p class="text-gray-500 text-sm p-4">No rezonings or subdivisions within 1.5 miles</p>';
            lucide.createIcons();
        }

        function renderSales() {
            let filtered = allSales;
            if (currentSalesFilter === 'llc') filtered = allSales.filter(s => s.listingType === 'New Construction');
            document.getElementById('sales-count').textContent = `${filtered.length} listings`;
            document.getElementById('sales-source').textContent = allSales[0]?.source === 'RentCast' ? 'Live listings from RentCast' : 'Use links above for complete records';
            const emptyMessage = allSales.length === 0
                ? `<tr><td colspan="6" class="px-4 py-8 text-center"><p class="text-gray-500 mb-1">Listings unavailable</p><p class="text-gray-400 text-sm">Try &quot;Refresh sales&quot; above, or use Redfin / Register of Deeds links</p></td></tr>`
                : '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No listings match filter</td></tr>';
            document.getElementById('sales-table').innerHTML = filtered.length > 0 ?
                filtered.map(s => {
                    const typeBadge = s.listingType === 'New Construction' ? '<span class="px-2 py-1 text-xs font-semibold bg-purple-100 text-purple-700 rounded-lg">New Build</span>'
                        : s.listingType === 'Foreclosure' ? '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-lg">Foreclosure</span>'
                        : s.listingType ? `<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-lg">${s.listingType}</span>` : '';
                    return `<tr class="${s.listingType === 'New Construction' ? 'bg-purple-50' : ''}">
                        <td class="px-4 py-3 font-medium text-gray-900">${s.address}</td>
                        <td class="px-4 py-3 text-gray-600 text-sm">${s.buyer || '-'}</td>
                        <td class="px-4 py-3 text-emerald-600 font-medium">${s.price}</td>
                        <td class="px-4 py-3 text-gray-500">${s.date}</td>
                        <td class="px-4 py-3 text-gray-500 hidden sm:table-cell">${s.beds}/${s.baths}</td>
                        <td class="px-4 py-3">${typeBadge}</td>
                    </tr>`;
                }).join('') : emptyMessage;
        }

        // ============================================
        // SEARCH
        // ============================================
        let searchTimeout = null;

        function handleSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(query), 150);
            document.getElementById('search-clear').classList.toggle('hidden', !query);
        }

        function performSearch(query) {
            const resultsContainer = document.getElementById('search-results');
            if (!query || query.length < 2) { resultsContainer.classList.add('hidden'); return; }
            const q = query.toLowerCase();
            const allSearchable = [
                ...allRezonings.map(r => ({ ...r, _render: 'rezoning' })),
                ...approvedRezonings.map(r => ({ ...r, _render: 'rezoning' })),
                ...allSubdivisions.map(s => ({ ...s, _render: 'subdivision', petition: s.name, petitioner: s.developer, proposedZoning: s.zoning }))
            ];
            const matches = allSearchable.filter(r => {
                return [r.petition, r.name, r.address, r.petitioner, r.developer, r.currentZoning, r.proposedZoning, r.zoning, r.proposedUse, r.planType, r.description].filter(Boolean).join(' ').toLowerCase().includes(q);
            });
            matches.sort((a, b) => { if (a.isApproved && !b.isApproved) return 1; if (!a.isApproved && b.isApproved) return -1; return (a.distance || 999) - (b.distance || 999); });

            if (matches.length > 0) {
                resultsContainer.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-sm text-gray-600">Found <span class="text-emerald-600 font-bold">${matches.length}</span> results</p>
                        <button onclick="clearSearch()" class="text-xs text-gray-400 hover:text-gray-700">Clear</button>
                    </div>
                    <div class="space-y-2">${matches.slice(0, 10).map(r => renderSearchResult(r)).join('')}</div>
                    ${matches.length > 10 ? `<p class="text-xs text-gray-400 mt-3 text-center">Showing 10 of ${matches.length} results</p>` : ''}`;
                resultsContainer.classList.remove('hidden');
            } else {
                const isWatchedDev = WATCHED_DEVS.some(d => d.toLowerCase().includes(q) || q.includes(d.toLowerCase()));
                resultsContainer.innerHTML = `<div class="text-center py-4">
                    ${isWatchedDev ? '<p class="text-emerald-600 text-sm mb-2">This developer is on your watch list — no active petitions found.</p>' : ''}
                    <p class="text-gray-500">${isWatchedDev ? '' : `No results for "${query}"`}</p>
                    <p class="text-xs text-gray-400 mt-1">Try: a street name, developer name, or petition #</p>
                </div>`;
                resultsContainer.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function renderSearchResult(r) {
            const distanceBadge = r.distance ? `<span class="text-emerald-600 font-medium text-xs">${r.distance.toFixed(1)} mi</span>` : '';
            const typeBadge = r.type === 'high-density' ? '<span class="px-1.5 py-0.5 text-xs font-semibold bg-red-100 text-red-700 rounded-lg">High Density</span>' :
                             r.type === 'lotsplit' ? '<span class="px-1.5 py-0.5 text-xs font-semibold bg-amber-100 text-amber-700 rounded-lg">Lot Split</span>' : '';
            const isSub = r._render === 'subdivision' || r.isSubdivision;
            const label = isSub ? r.name : `Petition ${r.petition}`;
            const subBadge = isSub ? '<span class="px-1.5 py-0.5 text-xs font-semibold bg-cyan-100 text-cyan-700 rounded-lg">Subdivision</span>' : '';
            const searchUrl = !isSub ? getSearchUrl(r.petition) : (r.rezoningPetition ? getSearchUrl(r.rezoningPetition) : null);

            return `
                <div class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer border border-gray-100" onclick="${isSub ? '' : `jumpToRezoning('${r.petition}')`}">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <span class="font-bold text-gray-900 text-sm">${label}</span>
                                ${subBadge} ${typeBadge} ${distanceBadge}
                            </div>
                            <p class="text-gray-700 text-sm truncate">${r.address || 'Location: see details'}</p>
                            <p class="text-xs text-gray-500 mt-0.5">${isSub ? `Developer: ${r.developer}` : `Petitioner: ${r.petitioner}`}</p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            ${searchUrl ? `<a href="${searchUrl}" target="_blank" onclick="event.stopPropagation()" class="px-2.5 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-bold whitespace-nowrap">More Info</a>` : ''}
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                        </div>
                    </div>
                </div>`;
        }

        function jumpToRezoning(petition) {
            clearSearch();
            showTab('rezonings');
            setTimeout(() => {
                const cards = document.querySelectorAll('#all-rezonings > div');
                for (const card of cards) {
                    if (card.textContent.includes(`Petition ${petition}`)) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.classList.add('ring-2', 'ring-emerald-500');
                        setTimeout(() => card.classList.remove('ring-2', 'ring-emerald-500'), 3000);
                        break;
                    }
                }
            }, 100);
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('search-clear').classList.add('hidden');
        }

        // ============================================
        // UI
        // ============================================
        function scrollToSection(sectionId) {
            showTab('overview');
            setTimeout(() => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    section.classList.add('ring-2', 'ring-emerald-400');
                    setTimeout(() => section.classList.remove('ring-2', 'ring-emerald-400'), 2000);
                }
            }, 100);
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-white', 'text-gray-900', 'shadow-sm', 'font-semibold');
                el.classList.add('text-gray-500', 'font-medium');
            });
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            const btn = document.querySelector(`[data-tab="${tabId}"]`);
            btn.classList.remove('text-gray-500', 'font-medium');
            btn.classList.add('bg-white', 'text-gray-900', 'shadow-sm', 'font-semibold');
        }

        function filterRezonings(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(el => {
                el.classList.remove('bg-emerald-600', 'text-white', 'shadow-sm');
                el.classList.add('bg-gray-100', 'text-gray-600');
            });
            const btn = document.querySelector(`[data-filter="${filter}"]`);
            btn.classList.remove('bg-gray-100', 'text-gray-600');
            btn.classList.add('bg-emerald-600', 'text-white', 'shadow-sm');
            renderAllRezonings();
        }

        function filterSales(filter) {
            currentSalesFilter = filter;
            document.querySelectorAll('.sales-filter-btn').forEach(el => {
                el.classList.remove('bg-emerald-600', 'text-white');
                el.classList.add('bg-gray-100', 'text-gray-600');
            });
            const btn = document.querySelector(`[data-sales-filter="${filter}"]`);
            btn.classList.remove('bg-gray-100', 'text-gray-600');
            btn.classList.add('bg-emerald-600', 'text-white');
            renderSales();
        }

        // ============================================
        // MAIN
        // ============================================
        function setSpinner(spinning) {
            const btn = document.getElementById('refresh-btn');
            if (!btn) return;
            const icon = btn.querySelector('svg, i');
            if (icon) { if (spinning) icon.classList.add('animate-spin'); else icon.classList.remove('animate-spin'); }
        }

        async function refreshAllData() {
            setSpinner(true);
            hideError();
            const spinnerTimeout = setTimeout(() => { setSpinner(false); }, 30000);
            try {
                const features = await fetchRezonings();
                allRezonings = await processRezonings(features);
                const [approvedFeatures, subdivisionFeatures] = await Promise.all([
                    fetchApprovedRezonings().catch(() => []),
                    fetchSubdivisions().catch(() => [])
                ]);
                try { approvedRezonings = await processApprovedRezonings(approvedFeatures); } catch (e) { approvedRezonings = []; }
                try { allSubdivisions = processSubdivisions(subdivisionFeatures); nearbySubdivisions = allSubdivisions.filter(s => s.distance <= SEARCH_RADIUS_MILES); } catch (e) { allSubdivisions = []; nearbySubdivisions = []; }
                approvedRezonings.forEach(r => { if (r.lat && r.lon) r.distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, r.lat, r.lon); });
                nearbyRezonings = filterNearby(allRezonings);
                nearbyApproved = approvedRezonings.filter(r => r.distance && r.distance <= SEARCH_RADIUS_MILES).sort((a, b) => (a.distance || 999) - (b.distance || 999));
                try { await enrichWithAddresses(allRezonings); await enrichWithAddresses(approvedRezonings); } catch (e) {}
                try { allSales = await fetchSalesData(); } catch (e) { allSales = []; }
                try { renderOverview(); } catch (e) { console.error('Error rendering overview:', e); }
                try { renderAllRezonings(); } catch (e) {}
                try { renderNearbyRezonings(); } catch (e) {}
                try { renderSales(); } catch (e) {}
                document.getElementById('last-updated').textContent = `Updated: ${new Date().toLocaleString()}`;
            } catch (error) {
                console.error('Fatal error:', error);
                showError(error.message);
            } finally {
                clearTimeout(spinnerTimeout);
                setSpinner(false);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            const devLinksContainer = document.getElementById('watched-dev-links');
            if (devLinksContainer) {
                devLinksContainer.innerHTML = WATCHED_DEVS.map(dev =>
                    `<a href="https://meckrod.manatron.com/RealEstate/SearchEntry.aspx" target="_blank" class="px-3 py-2 bg-purple-100 hover:bg-purple-200 rounded-xl text-xs font-medium text-purple-700 transition-colors" title="Search deeds for ${dev}">${dev}</a>`
                ).join('');
            }
            refreshAllData();
        });
    </script>
</body>
</html>
