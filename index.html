<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mammoth Oaks / Lansdowne Development Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'JetBrains Mono', monospace; }
        .loading-shimmer {
            background: linear-gradient(90deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- Header -->
    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                        <i data-lucide="home" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight">Mammoth Oaks / Lansdowne</h1>
                        <p class="text-xs text-slate-500 tracking-wide">DEVELOPMENT TRACKER • 28270</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="refreshAllData()" class="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors text-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4" id="refresh-icon"></i>
                        Refresh
                    </button>
                    <div class="text-xs text-slate-500" id="last-updated">Loading...</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Error Banner -->
        <div id="error-banner" class="hidden mb-6 p-4 rounded-lg bg-gradient-to-r from-red-950/50 to-red-900/30 border border-red-800/50">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                <div>
                    <p class="font-semibold text-red-300">Error Loading Data</p>
                    <p class="text-sm text-red-400/80" id="error-message"></p>
                </div>
            </div>
        </div>

        <!-- Alert Banner -->
        <div id="alert-banner" class="hidden mb-6 p-4 rounded-lg bg-gradient-to-r from-red-950/50 to-orange-950/50 border border-red-800/50">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400"></i>
                <div>
                    <p class="font-semibold text-red-300" id="alert-count">Loading...</p>
                    <p class="text-sm text-red-400/80">Active rezoning petitions near your neighborhood</p>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500"></i>
                <input type="text" id="search-input"
                       placeholder="Search by address, street, petition #, or developer name..."
                       oninput="handleSearch(this.value)"
                       class="w-full pl-12 pr-4 py-3 bg-slate-900 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500/50 text-sm">
                <div id="search-clear" class="hidden absolute right-4 top-1/2 -translate-y-1/2 cursor-pointer text-slate-500 hover:text-white" onclick="clearSearch()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </div>
            </div>
            <div id="search-results" class="hidden mt-3 p-4 rounded-xl bg-slate-900 border border-slate-800 max-h-96 overflow-y-auto">
                <!-- Search results will appear here -->
            </div>
        </div>

        <!-- Stats Cards - Clickable -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
            <div onclick="scrollToSection('critical-alerts')" class="p-4 rounded-lg bg-slate-900 border border-slate-800 cursor-pointer hover:border-red-500/50 hover:bg-slate-800/50 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="building-2" class="w-4 h-4 text-red-500"></i>
                    <span class="text-xs text-slate-500">NEARBY</span>
                </div>
                <div class="text-2xl font-bold" id="stat-critical">-</div>
                <div class="text-xs text-slate-500">High-Density</div>
            </div>
            <div onclick="scrollToSection('lotsplit-overview')" class="p-4 rounded-lg bg-slate-900 border border-slate-800 cursor-pointer hover:border-amber-500/50 hover:bg-slate-800/50 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="scissors" class="w-4 h-4 text-amber-500"></i>
                    <span class="text-xs text-slate-500">NEARBY</span>
                </div>
                <div class="text-2xl font-bold" id="stat-lotsplits">-</div>
                <div class="text-xs text-slate-500">Lot Splits</div>
            </div>
            <div onclick="scrollToSection('approved-overview')" class="p-4 rounded-lg bg-slate-900 border border-slate-800 cursor-pointer hover:border-purple-500/50 hover:bg-slate-800/50 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="check-circle" class="w-4 h-4 text-purple-500"></i>
                    <span class="text-xs text-slate-500">NEARBY</span>
                </div>
                <div class="text-2xl font-bold" id="stat-approved">-</div>
                <div class="text-xs text-slate-500">Recently Approved</div>
            </div>
            <div onclick="scrollToSection('nearby-overview')" class="p-4 rounded-lg bg-slate-900 border border-slate-800 cursor-pointer hover:border-emerald-500/50 hover:bg-slate-800/50 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="map-pin" class="w-4 h-4 text-emerald-500"></i>
                    <span class="text-xs text-slate-500">NEARBY</span>
                </div>
                <div class="text-2xl font-bold" id="stat-nearby">-</div>
                <div class="text-xs text-slate-500">All Within 3 Mi</div>
            </div>
            <div onclick="showTab('rezonings')" class="p-4 rounded-lg bg-slate-900 border border-slate-800 cursor-pointer hover:border-amber-500/50 hover:bg-slate-800/50 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="file-text" class="w-4 h-4 text-amber-500"></i>
                    <span class="text-xs text-slate-500">CITYWIDE</span>
                </div>
                <div class="text-2xl font-bold" id="stat-rezonings">-</div>
                <div class="text-xs text-slate-500">Total Active</div>
            </div>
            <div onclick="showTab('sales')" class="p-4 rounded-lg bg-slate-900 border border-slate-800 cursor-pointer hover:border-blue-500/50 hover:bg-slate-800/50 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="dollar-sign" class="w-4 h-4 text-blue-500"></i>
                    <span class="text-xs text-slate-500">TRACKED</span>
                </div>
                <div class="text-2xl font-bold" id="stat-sales">-</div>
                <div class="text-xs text-slate-500">Recent Sales</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-1 mb-6 p-1 bg-slate-900 rounded-lg w-fit flex-wrap">
            <button onclick="showTab('overview')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all bg-amber-600 text-white" data-tab="overview">Overview</button>
            <button onclick="showTab('rezonings')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all text-slate-400 hover:text-white hover:bg-slate-800" data-tab="rezonings">All Rezonings</button>
            <button onclick="showTab('nearby')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all text-slate-400 hover:text-white hover:bg-slate-800" data-tab="nearby">Near Us</button>
            <button onclick="showTab('sales')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all text-slate-400 hover:text-white hover:bg-slate-800" data-tab="sales">Property Sales</button>
        </div>

        <!-- Tab: Overview -->
        <div id="tab-overview" class="tab-content">
            <div class="space-y-6">
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-4 h-4 text-red-400"></i>
                        HIGH DENSITY PROJECTS NEAR YOU
                    </h2>
                    <div id="critical-alerts" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-lg"></div>
                    </div>
                </section>
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="scissors" class="w-4 h-4 text-amber-400"></i>
                        LOT SPLITS NEAR YOU
                    </h2>
                    <div id="lotsplit-overview" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-lg"></div>
                    </div>
                </section>
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-4 h-4 text-emerald-400"></i>
                        ALL NEARBY REZONINGS (3 MILES)
                    </h2>
                    <div id="nearby-overview" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-lg"></div>
                    </div>
                </section>
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-purple-400"></i>
                        RECENTLY APPROVED (COMING SOON)
                    </h2>
                    <p class="text-xs text-slate-500 mb-2">These rezonings were approved in the last 2 years - development is likely underway or imminent.</p>
                    <div id="approved-overview" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-lg"></div>
                    </div>
                </section>
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="dollar-sign" class="w-4 h-4 text-blue-400"></i>
                        RECENT SALES & LLC PURCHASES
                    </h2>
                    <div id="sales-overview" class="space-y-3">
                        <p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">
                            Loading sales data...
                        </p>
                    </div>
                </section>
            </div>
        </div>

        <!-- Tab: All Rezonings -->
        <div id="tab-rezonings" class="tab-content hidden">
            <div class="mb-4 flex items-center gap-4 flex-wrap">
                <div class="flex gap-2">
                    <button onclick="filterRezonings('all')" class="filter-btn px-3 py-1.5 text-xs rounded-lg bg-amber-600 text-white" data-filter="all">All Active</button>
                    <button onclick="filterRezonings('high-density')" class="filter-btn px-3 py-1.5 text-xs rounded-lg bg-slate-800 text-slate-400" data-filter="high-density">High-Density</button>
                    <button onclick="filterRezonings('lotsplit')" class="filter-btn px-3 py-1.5 text-xs rounded-lg bg-slate-800 text-slate-400" data-filter="lotsplit">Lot Splits</button>
                    <button onclick="filterRezonings('approved')" class="filter-btn px-3 py-1.5 text-xs rounded-lg bg-slate-800 text-slate-400" data-filter="approved">Recently Approved</button>
                </div>
                <div class="text-xs text-slate-500" id="rezoning-count">Loading...</div>
            </div>
            <div id="all-rezonings" class="space-y-4">
                <div class="loading-shimmer h-32 rounded-lg"></div>
            </div>
        </div>

        <!-- Tab: Nearby -->
        <div id="tab-nearby" class="tab-content hidden">
            <div class="mb-4 p-4 rounded-lg bg-slate-900 border border-slate-800">
                <p class="text-sm text-slate-400">Rezonings within <span class="text-amber-400 font-semibold">3 miles</span> of Mammoth Oaks (35.1328°N, 80.8140°W)</p>
            </div>
            <div id="nearby-rezonings" class="space-y-4">
                <div class="loading-shimmer h-32 rounded-lg"></div>
            </div>
        </div>

        <!-- Tab: Sales -->
        <div id="tab-sales" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-white mb-2">Property Sales Lookup</h2>
                <p class="text-sm text-slate-400">Search recent sales in Mammoth Oaks / Lansdowne (28270) using these free resources. Look for LLC buyers - they're often developers planning to split lots or build multiple units.</p>
            </div>

            <!-- Quick Search Links -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,viewport=35.17073:35.09487:-80.76157:-80.86643" target="_blank" class="p-4 rounded-lg bg-gradient-to-br from-red-950/40 to-red-900/20 border border-red-800/50 hover:border-red-600 transition-colors group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 rounded-lg bg-red-600 flex items-center justify-center text-white font-bold">R</div>
                        <div>
                            <p class="font-semibold text-white group-hover:text-red-300">Redfin - Sold Homes</p>
                            <p class="text-xs text-slate-500">Last 3 months</p>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400">Best for recent MLS sales with photos, sale prices, and days on market.</p>
                </a>
                <a href="https://www.zillow.com/charlotte-nc-28270/sold/?searchQueryState=%7B%22pagination%22%3A%7B%7D%2C%22usersSearchTerm%22%3A%2228270%22%2C%22mapBounds%22%3A%7B%22north%22%3A35.17%2C%22south%22%3A35.09%2C%22east%22%3A-80.76%2C%22west%22%3A-80.87%7D%2C%22filterState%22%3A%7B%22sort%22%3A%7B%22value%22%3A%22days%22%7D%2C%22ah%22%3A%7B%22value%22%3Atrue%7D%2C%22rs%22%3A%7B%22value%22%3Atrue%7D%2C%22fsba%22%3A%7B%22value%22%3Afalse%7D%2C%22fsbo%22%3A%7B%22value%22%3Afalse%7D%2C%22nc%22%3A%7B%22value%22%3Afalse%7D%2C%22cmsn%22%3A%7B%22value%22%3Afalse%7D%2C%22auc%22%3A%7B%22value%22%3Afalse%7D%2C%22fore%22%3A%7B%22value%22%3Afalse%7D%7D%7D" target="_blank" class="p-4 rounded-lg bg-gradient-to-br from-blue-950/40 to-blue-900/20 border border-blue-800/50 hover:border-blue-600 transition-colors group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white font-bold">Z</div>
                        <div>
                            <p class="font-semibold text-white group-hover:text-blue-300">Zillow - Sold Homes</p>
                            <p class="text-xs text-slate-500">Recently sold</p>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400">Zestimate history, tax records, and neighborhood comparables.</p>
                </a>
                <a href="https://polaris3g.mecklenburgcountync.gov/" target="_blank" class="p-4 rounded-lg bg-gradient-to-br from-emerald-950/40 to-emerald-900/20 border border-emerald-800/50 hover:border-emerald-600 transition-colors group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 rounded-lg bg-emerald-600 flex items-center justify-center text-white font-bold">P</div>
                        <div>
                            <p class="font-semibold text-white group-hover:text-emerald-300">POLARIS - Official Deeds</p>
                            <p class="text-xs text-slate-500">County records</p>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400">ALL recorded sales from Mecklenburg County. Shows buyer names including LLCs.</p>
                </a>
            </div>

            <!-- How to spot developer purchases -->
            <div class="p-4 rounded-lg bg-amber-950/30 border border-amber-800/50 mb-6">
                <h3 class="font-semibold text-amber-300 mb-2 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                    How to Spot Developer Purchases
                </h3>
                <ul class="text-sm text-slate-300 space-y-1 list-disc list-inside">
                    <li>Buyer name contains <strong>LLC, LP, Inc, Holdings, Properties, Investments, or Trust</strong></li>
                    <li>Cash purchases (no mortgage recorded)</li>
                    <li>Older homes on large lots (prime for lot splits)</li>
                    <li>Multiple properties purchased by same buyer</li>
                    <li>Below-market purchases (motivated sellers)</li>
                </ul>
            </div>

            <!-- Specific street searches -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 mb-3">QUICK STREET SEARCHES</h3>
                <div class="flex flex-wrap gap-2">
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=preston" target="_blank" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-slate-300">Preston Ln</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=lansdowne" target="_blank" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-slate-300">Lansdowne</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=lansing" target="_blank" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-slate-300">Lansing Dr</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=mammoth" target="_blank" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-slate-300">Mammoth Oaks</a>
                    <a href="https://www.redfin.com/zipcode/28270/filter/include=sold-3mo,keyword=sharon" target="_blank" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-slate-300">Sharon View</a>
                </div>
            </div>

            <!-- API Data section (when available) -->
            <div class="border-t border-slate-800 pt-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-sm font-semibold text-slate-400">CACHED SALES DATA</h3>
                        <p class="text-xs text-slate-500 mt-1" id="sales-source">Automatically updates when API is available</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="filterSales('all')" class="sales-filter-btn px-3 py-1.5 text-xs rounded-lg bg-amber-600 text-white" data-sales-filter="all">All</button>
                        <button onclick="filterSales('llc')" class="sales-filter-btn px-3 py-1.5 text-xs rounded-lg bg-slate-800 text-slate-400" data-sales-filter="llc">LLC Only</button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-800">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">ADDRESS</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">BUYER</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">PRICE</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">SOLD</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">BEDS/BATHS</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">FLAGS</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table" class="divide-y divide-slate-800">
                        <tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">Loading sales data...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-xs text-slate-500" id="sales-count">0 sales</div>
        </div>
    </main>

    <footer class="border-t border-slate-800 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-slate-500">
            Data from Charlotte Planning ArcGIS • Mecklenburg County POLARIS • Updated automatically
        </div>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const NEIGHBORHOOD_CENTER = { lat: 35.1328, lon: -80.8140 };
        const SEARCH_RADIUS_MILES = 3;
        const ZIP_CODE = '28270';

        // APIs
        const REZONING_API = 'https://gis.charlottenc.gov/arcgis/rest/services/PLN/Rezonings/MapServer/0/query';
        const REZONING_HISTORY_API = 'https://gis.charlottenc.gov/arcgis/rest/services/PLN/RezoningHistory/MapServer/0/query';
        const ADDRESS_API = 'https://gis.charlottenc.gov/arcgis/rest/services/CountyData/MasterAddress/MapServer/0/query';

        // Keywords
        const HIGH_DENSITY = ['townhome', 'townhouse', 'multi-family', 'multifamily', 'attached', 'N2-A', 'N2-B', 'UR-2', 'UR-3', 'apartment', 'condo', 'duplex', 'triplex', 'MF', 'TOD', 'MUDD'];
        const LOTSPLIT = ['N1-C', 'subdivision', 'split', 'two lot', '2 lot'];
        const WATCHED_DEVS = ['Veer Homes', 'THR Design', 'THR Build', 'Pike Properties', 'Northway', 'Sinacori', 'Epic Homes', 'Forte Builders', 'DR Horton', 'Lennar', 'Pulte', 'Meritage'];
        const LLC_PATTERNS = ['LLC', 'L.L.C.', 'LP', 'L.P.', 'INC', 'CORP', 'HOLDINGS', 'INVESTMENTS', 'DEVELOPMENT', 'PROPERTIES', 'VENTURES', 'CAPITAL', 'PARTNERS', 'GROUP', 'TRUST'];

        // Storage
        const API_KEY_STORAGE = 'mammoth_oaks_api_key';
        const SALES_CACHE = 'mammoth_oaks_sales_cache';
        const ADDRESS_CACHE = 'mammoth_oaks_address_cache';

        // Default API key (RentCast free tier - 50 calls/month)
        const DEFAULT_RENTCAST_KEY = '8b894ad1348e4918ae3443328dadc07a';

        // State
        let allRezonings = [];
        let nearbyRezonings = [];
        let approvedRezonings = [];
        let nearbyApproved = [];
        let allSales = [];
        let addressCache = {};
        let currentFilter = 'all';
        let currentSalesFilter = 'all';

        // ============================================
        // ZONING TRANSLATOR - Plain English descriptions
        // ============================================

        function getZoningDescription(code) {
            if (!code || code === '-') return 'Unknown';
            const c = code.toUpperCase().replace(/\(CD\)|\(SPA\)|\(LLWPA\)/g, '').trim();

            // Single-family residential (good)
            if (/^R-3|^R-4|^R-5|^R-6|^R-8|^R-MH/.test(c)) return 'Single-family homes';
            if (/^N1-A|^N1-B/.test(c)) return 'Single-family homes';
            if (/^RE-1|^RE-2|^RE-3/.test(c)) return 'Large lot single-family';

            // Lot splits (warning)
            if (/^N1-C/.test(c)) return 'Lot splits allowed (2-3 homes per lot)';

            // Attached/Townhomes (high density)
            if (/^N1-D|^N1-E/.test(c)) return 'Small lot single-family or duplexes';
            if (/^N2-A/.test(c)) return 'Townhomes & duplexes (8-12 units/acre)';
            if (/^N2-B/.test(c)) return 'Townhomes & triplexes (12-17 units/acre)';

            // Multi-family (highest density)
            if (/^UR-1/.test(c)) return 'Urban residential (8-12 units/acre)';
            if (/^UR-2/.test(c)) return 'Apartments & condos (12-18 units/acre)';
            if (/^UR-3/.test(c)) return 'High-rise apartments (18-22+ units/acre)';
            if (/^MF/.test(c)) return 'Multi-family apartments';

            // Mixed-use (very high density)
            if (/^TOD/.test(c)) return 'Transit-oriented (apartments + retail)';
            if (/^MUDD/.test(c)) return 'Mixed-use (apartments + commercial)';
            if (/^MX/.test(c)) return 'Mixed-use development';
            if (/^CC/.test(c)) return 'Commercial center';
            if (/^TS/.test(c)) return 'Transit station area';

            // Commercial/Industrial
            if (/^B-1|^B-2|^NS|^O-1|^O-2/.test(c)) return 'Commercial/Office';
            if (/^I-1|^I-2/.test(c)) return 'Industrial';
            if (/^INST/.test(c)) return 'Institutional';

            // Legacy codes
            if (/^R-17MF|^R-22MF|^R-43MF/.test(c)) return 'Multi-family apartments';
            if (/^R-12MF/.test(c)) return 'Townhomes/apartments';

            return code; // Return original if unknown
        }

        function getZoningChangeDescription(fromZone, toZone) {
            const from = getZoningDescription(fromZone);
            const to = getZoningDescription(toZone);

            if (from === to) return null;
            return `${from} → ${to}`;
        }

        // ============================================
        // API FUNCTIONS
        // ============================================

        async function fetchRezonings() {
            const params = new URLSearchParams({
                where: '1=1',
                outFields: '*',
                f: 'json',
                returnGeometry: 'true',
                outSR: '4326'
            });
            const response = await fetch(`${REZONING_API}?${params}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.features || [];
        }

        async function fetchApprovedRezonings() {
            // Fetch rezonings approved in the last 2 years (developments take years to complete)
            // Use DATE format for ArcGIS API compatibility
            const twoYearsAgo = new Date(Date.now() - (730 * 24 * 60 * 60 * 1000));
            const dateStr = twoYearsAgo.toISOString().split('T')[0]; // Format: YYYY-MM-DD
            const params = new URLSearchParams({
                where: `Status = 'App' AND Approved >= DATE '${dateStr}'`,
                outFields: '*',
                f: 'json',
                returnGeometry: 'true',
                outSR: '4326'
            });
            try {
                const response = await fetch(`${REZONING_HISTORY_API}?${params}`);
                if (!response.ok) return [];
                const data = await response.json();
                if (data.error) return [];
                return data.features || [];
            } catch (e) {
                console.error('Error fetching approved rezonings:', e);
                return [];
            }
        }

        async function processApprovedRezonings(features) {
            const results = [];

            for (const f of features) {
                const a = f.attributes;
                const geom = f.geometry;

                // Calculate centroid
                let lat = null, lon = null;
                if (geom && geom.rings && geom.rings[0]) {
                    const ring = geom.rings[0];
                    lon = ring.reduce((sum, pt) => sum + pt[0], 0) / ring.length;
                    lat = ring.reduce((sum, pt) => sum + pt[1], 0) / ring.length;
                }

                // Get zoning info
                const existZone = a.ExistingZoning || a.ExistZone || '-';
                const reqZone = a.RequestedZoning || a.ReqZone || '-';
                const propLuse = a.Propluse || '';

                // Determine type
                const allText = `${existZone} ${reqZone} ${propLuse} ${a.Petitioner || ''}`.toLowerCase();
                let type = 'other';
                if (HIGH_DENSITY.some(kw => allText.includes(kw.toLowerCase()))) {
                    type = 'high-density';
                } else if (LOTSPLIT.some(kw => allText.includes(kw.toLowerCase()))) {
                    type = 'lotsplit';
                }

                // Check for watched developers
                const petitioner = a.Petitioner || '';
                const isWatched = WATCHED_DEVS.some(dev => petitioner.toLowerCase().includes(dev.toLowerCase()));

                // Build description
                let description = `Rezoned from ${existZone} to ${reqZone}`;
                if (propLuse) description += ` for ${propLuse}`;

                // Get approval date
                let approvedDate = null;
                if (a.Approved) approvedDate = new Date(a.Approved).toLocaleDateString();

                results.push({
                    id: a.Petition || a.OBJECTID,
                    petition: a.Petition || 'Unknown',
                    petitioner: petitioner || 'Unknown',
                    currentZoning: existZone,
                    proposedZoning: reqZone,
                    proposedUse: propLuse,
                    status: 'Approved',
                    description: description,
                    approvedDate: approvedDate,
                    acres: a.Acres || a.PetAcres || null,
                    type: type,
                    isWatched: isWatched,
                    isApproved: true,
                    lat: lat,
                    lon: lon,
                    address: null,
                    link: `https://rezoning.org/petition/${a.Petition}`
                });
            }

            return results;
        }

        async function lookupAddress(lat, lon) {
            // Check cache first
            const cacheKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;
            if (addressCache[cacheKey]) return addressCache[cacheKey];

            try {
                // Query addresses within ~500ft of the point
                const buffer = 0.002; // ~0.002 degrees ≈ 700ft
                const params = new URLSearchParams({
                    where: '1=1',
                    geometry: JSON.stringify({
                        xmin: lon - buffer,
                        ymin: lat - buffer,
                        xmax: lon + buffer,
                        ymax: lat + buffer,
                        spatialReference: { wkid: 4326 }
                    }),
                    geometryType: 'esriGeometryEnvelope',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: 'FullAddress,ZipCode',
                    returnGeometry: 'false',
                    f: 'json',
                    resultRecordCount: 1
                });

                const response = await fetch(`${ADDRESS_API}?${params}`);
                if (!response.ok) return null;

                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    const addr = data.features[0].attributes.FullAddress;
                    addressCache[cacheKey] = addr;
                    // Save cache
                    localStorage.setItem(ADDRESS_CACHE, JSON.stringify(addressCache));
                    return addr;
                }
            } catch (e) {
                console.error('Address lookup error:', e);
            }
            return null;
        }

        async function fetchSalesData() {
            const apiKey = localStorage.getItem(API_KEY_STORAGE) || DEFAULT_RENTCAST_KEY;

            // First check cache to avoid burning API calls
            const cached = localStorage.getItem(SALES_CACHE);
            if (cached) {
                const { timestamp, sales } = JSON.parse(cached);
                // Use cache if less than 6 hours old
                if (Date.now() - timestamp < 21600000) {
                    return sales;
                }
            }

            if (apiKey) {
                try {
                    // Single API call to get recent sales in the ZIP code
                    const response = await fetch(`https://api.rentcast.io/v1/properties?zipCode=${ZIP_CODE}&limit=50`, {
                        headers: { 'X-Api-Key': apiKey }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            const sales = data
                                .filter(p => p.lastSaleDate) // Only properties with sale history
                                .map(p => ({
                                    address: p.formattedAddress || p.addressLine1,
                                    price: p.lastSalePrice ? `$${p.lastSalePrice.toLocaleString()}` : 'N/A',
                                    priceNum: p.lastSalePrice || 0,
                                    date: p.lastSaleDate || 'Unknown',
                                    beds: p.bedrooms || '-',
                                    baths: p.bathrooms || '-',
                                    sqft: p.squareFootage ? p.squareFootage.toLocaleString() : '-',
                                    buyer: p.ownerName || '',
                                    isLLC: LLC_PATTERNS.some(pat => ((p.ownerName || '') + ' ' + (p.formattedAddress || '')).toUpperCase().includes(pat)),
                                    isWatched: WATCHED_DEVS.some(d => ((p.ownerName || '') + ' ' + (p.formattedAddress || '')).toLowerCase().includes(d.toLowerCase())),
                                    source: 'RentCast'
                                }))
                                .sort((a, b) => new Date(b.date) - new Date(a.date));

                            if (sales.length > 0) {
                                localStorage.setItem(SALES_CACHE, JSON.stringify({ timestamp: Date.now(), sales }));
                                return sales;
                            }
                        }
                    } else if (response.status === 429 || response.status === 403) {
                        console.log('RentCast API limit reached or access denied');
                    }
                } catch (e) {
                    console.error('RentCast API error:', e);
                }
            }

            // Return cached data even if older than 6 hours (better than nothing)
            if (cached) {
                const { sales } = JSON.parse(cached);
                return sales;
            }

            // Return empty - user should check POLARIS for real sales data
            return [];
        }

        // ============================================
        // DATA PROCESSING
        // ============================================

        async function processRezonings(features) {
            const results = [];

            for (const f of features) {
                const a = f.attributes;
                const geom = f.geometry;

                // Calculate centroid
                let lat = null, lon = null;
                if (geom && geom.rings && geom.rings[0]) {
                    const ring = geom.rings[0];
                    lon = ring.reduce((sum, pt) => sum + pt[0], 0) / ring.length;
                    lat = ring.reduce((sum, pt) => sum + pt[1], 0) / ring.length;
                }

                // Get zoning info
                const existZone = a.ExistZone || '-';
                const reqZone = a.ReqZone || '-';
                const propLuse = a.Propluse || '';

                // Determine type
                const allText = `${existZone} ${reqZone} ${propLuse} ${a.Petitioner || ''}`.toLowerCase();
                let type = 'other';
                if (HIGH_DENSITY.some(kw => allText.includes(kw.toLowerCase()))) {
                    type = 'high-density';
                } else if (LOTSPLIT.some(kw => allText.includes(kw.toLowerCase()))) {
                    type = 'lotsplit';
                }

                // Check for watched developers
                const petitioner = a.Petitioner || '';
                const isWatched = WATCHED_DEVS.some(dev => petitioner.toLowerCase().includes(dev.toLowerCase()));

                // Build description
                let description = `Rezone from ${existZone} to ${reqZone}`;
                if (propLuse) description += ` for ${propLuse}`;

                // Try to get hearing date if available
                let hearingDate = null;
                if (a.HearingDate) hearingDate = new Date(a.HearingDate).toLocaleDateString();
                else if (a.Hearing_Date) hearingDate = new Date(a.Hearing_Date).toLocaleDateString();
                else if (a.ZoningDate) hearingDate = new Date(a.ZoningDate).toLocaleDateString();

                results.push({
                    id: a.Petition || a.OBJECTID,
                    petition: a.Petition || 'Unknown',
                    petitioner: petitioner || 'Unknown',
                    currentZoning: existZone,
                    proposedZoning: reqZone,
                    proposedUse: propLuse,
                    status: a.Status || 'Pending',
                    description: description,
                    filedDate: a.Received ? new Date(a.Received).toLocaleDateString() : null,
                    hearingDate: hearingDate,
                    acres: a.Acres || a.PetAcres || null,
                    type: type,
                    isWatched: isWatched,
                    lat: lat,
                    lon: lon,
                    address: null, // Will be filled in
                    link: a.Hyperlink || `https://rezoning.org/petition/${a.Petition}`
                });
            }

            return results;
        }

        async function enrichWithAddresses(rezonings) {
            // Load address cache
            const cached = localStorage.getItem(ADDRESS_CACHE);
            if (cached) addressCache = JSON.parse(cached);

            // Calculate distances for all rezonings
            rezonings.forEach(r => {
                if (r.lat && r.lon) {
                    r.distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, r.lat, r.lon);
                }
            });

            // Lookup addresses for ALL rezonings with geometry (use cache to minimize API calls)
            const needsLookup = rezonings.filter(r => !r.address && r.lat && r.lon);

            // Process in batches to avoid overwhelming the API
            const batchSize = 10;
            for (let i = 0; i < Math.min(needsLookup.length, 50); i += batchSize) {
                const batch = needsLookup.slice(i, i + batchSize);
                const lookupPromises = batch.map(async r => {
                    r.address = await lookupAddress(r.lat, r.lon);
                    return r;
                });
                await Promise.all(lookupPromises);
            }

            return rezonings;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function filterNearby(rezonings) {
            return rezonings.filter(r => {
                if (!r.lat || !r.lon) return false;
                if (!r.distance) {
                    r.distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, r.lat, r.lon);
                }
                return r.distance <= SEARCH_RADIUS_MILES;
            }).sort((a, b) => a.distance - b.distance);
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================

        function showError(message) {
            document.getElementById('error-banner').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        function hideError() {
            document.getElementById('error-banner').classList.add('hidden');
        }

        function renderRezoningCard(r, showDistance = false) {
            let bgColor = r.type === 'high-density' ? 'bg-red-950/30 border-red-800/50' :
                           r.type === 'lotsplit' ? 'bg-amber-950/30 border-amber-800/50' :
                           'bg-slate-900 border-slate-800';

            // Override for approved rezonings
            if (r.isApproved) {
                bgColor = r.type === 'high-density' ? 'bg-purple-950/30 border-purple-800/50' :
                          r.type === 'lotsplit' ? 'bg-purple-950/20 border-purple-800/30' :
                          'bg-purple-950/10 border-purple-800/20';
            }

            const typeBadge = r.type === 'high-density' ? '<span class="px-2 py-0.5 text-xs bg-red-900/50 text-red-300 rounded">HIGH DENSITY</span>' :
                             r.type === 'lotsplit' ? '<span class="px-2 py-0.5 text-xs bg-amber-900/50 text-amber-300 rounded">LOT SPLIT</span>' : '';

            const watchedBadge = r.isWatched ? '<span class="px-2 py-0.5 text-xs bg-purple-900/50 text-purple-300 rounded">WATCHED DEV</span>' : '';
            const approvedBadge = r.isApproved ? '<span class="px-2 py-0.5 text-xs bg-purple-900/50 text-purple-300 rounded">APPROVED</span>' : '';
            const distanceText = showDistance && r.distance ? `<span class="text-emerald-400 font-semibold">${r.distance.toFixed(1)} mi</span>` : '';

            // Show address if available, otherwise show petition number prominently
            const addressDisplay = r.address
                ? `<span class="font-semibold text-white">${r.address}</span>`
                : `<span class="text-slate-400">Location: see petition details</span>`;

            // Plain language zoning change description
            const plainChange = getZoningChangeDescription(r.currentZoning, r.proposedZoning);
            const plainChangeHtml = plainChange
                ? `<div class="mt-2 p-2 rounded bg-slate-800/50 border border-slate-700">
                       <p class="text-xs text-slate-500 mb-1">WHAT THIS MEANS:</p>
                       <p class="text-sm font-semibold text-white">${plainChange}</p>
                   </div>`
                : '';

            return `
                <div class="p-4 rounded-lg ${bgColor} border">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <span class="font-semibold text-amber-400">Petition ${r.petition}</span>
                                ${typeBadge}
                                ${watchedBadge}
                                ${approvedBadge}
                                ${!r.isApproved ? `<span class="px-2 py-0.5 text-xs bg-slate-700 text-slate-300 rounded">${r.status}</span>` : ''}
                                ${distanceText ? `<span class="text-xs">${distanceText}</span>` : ''}
                            </div>
                            <div class="mb-2">${addressDisplay}</div>
                            ${plainChangeHtml}
                            <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-xs text-slate-500 mt-3">
                                <div>Petitioner: <span class="text-slate-300">${r.petitioner}</span></div>
                                <div>Acres: <span class="text-slate-300">${r.acres || '-'}</span></div>
                                <div>Current: <span class="text-slate-300">${r.currentZoning}</span> <span class="text-slate-600">(${getZoningDescription(r.currentZoning)})</span></div>
                                <div>Proposed: <span class="text-amber-400 font-semibold">${r.proposedZoning}</span> <span class="text-slate-600">(${getZoningDescription(r.proposedZoning)})</span></div>
                                ${r.filedDate ? `<div>Filed: <span class="text-slate-300">${r.filedDate}</span></div>` : ''}
                                ${r.hearingDate ? `<div>Hearing: <span class="text-red-400 font-semibold">${r.hearingDate}</span></div>` : ''}
                                ${r.approvedDate ? `<div>Approved: <span class="text-purple-400 font-semibold">${r.approvedDate}</span></div>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <a href="${r.link}" target="_blank" class="flex items-center gap-1 px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors text-xs whitespace-nowrap">
                                Details <i data-lucide="external-link" class="w-3 h-3"></i>
                            </a>
                            ${r.lat && r.lon ? `<a href="https://polaris3g.mecklenburgcountync.gov/xy/${Math.round(r.lon * 1000000)},${Math.round(r.lat * 1000000)}" target="_blank" class="flex items-center gap-1 px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors text-xs whitespace-nowrap">POLARIS <i data-lucide="external-link" class="w-3 h-3"></i></a>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOverview() {
            // High density nearby
            const criticalNearby = nearbyRezonings.filter(r => r.type === 'high-density');
            document.getElementById('critical-alerts').innerHTML = criticalNearby.length > 0 ?
                criticalNearby.map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">No high-density projects within 3 miles - great news!</p>';

            // Lot splits nearby
            const lotSplitsNearby = nearbyRezonings.filter(r => r.type === 'lotsplit');
            document.getElementById('lotsplit-overview').innerHTML = lotSplitsNearby.length > 0 ?
                lotSplitsNearby.map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">No lot split petitions within 3 miles</p>';

            // All nearby
            document.getElementById('nearby-overview').innerHTML = nearbyRezonings.length > 0 ?
                nearbyRezonings.slice(0, 10).map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">No rezonings within 3 miles</p>';

            // Recently approved nearby
            const approvedNearby = nearbyApproved.filter(r => r.type === 'high-density' || r.isWatched);
            document.getElementById('approved-overview').innerHTML = nearbyApproved.length > 0 ?
                nearbyApproved.slice(0, 5).map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">No recently approved rezonings within 3 miles - this is typical if no major developments passed in the last year.</p>';

            // Sales
            const llcSales = allSales.filter(s => s.isLLC).slice(0, 5);
            document.getElementById('sales-overview').innerHTML = llcSales.length > 0 ?
                llcSales.map(s => `
                    <div class="p-3 bg-amber-950/30 border border-amber-800/50 rounded-lg flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-sm">${s.address}</div>
                            <div class="text-xs text-slate-400">${s.price} • ${s.date}</div>
                        </div>
                        <span class="px-2 py-0.5 text-xs bg-amber-900/50 text-amber-300 rounded">LLC</span>
                    </div>
                `).join('') :
                `<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">${allSales.length > 0 ? 'No LLC purchases detected in recent sales' : 'Loading sales data from RentCast...'}</p>`;

            // Stats - show NEARBY counts for the key metrics
            document.getElementById('stat-critical').textContent = criticalNearby.length;
            document.getElementById('stat-lotsplits').textContent = lotSplitsNearby.length;
            document.getElementById('stat-approved').textContent = nearbyApproved.length;
            document.getElementById('stat-nearby').textContent = nearbyRezonings.length;
            document.getElementById('stat-rezonings').textContent = allRezonings.length;
            document.getElementById('stat-sales').textContent = allSales.length;

            // Alert banner
            const alertCount = criticalNearby.length + nearbyRezonings.filter(r => r.isWatched).length;
            if (alertCount > 0) {
                document.getElementById('alert-banner').classList.remove('hidden');
                document.getElementById('alert-count').textContent = `${alertCount} development projects require attention`;
            } else {
                document.getElementById('alert-banner').classList.add('hidden');
            }

            lucide.createIcons();
        }

        function renderAllRezonings() {
            let filtered = allRezonings;
            let total = allRezonings.length;
            let countLabel = 'active petitions';

            if (currentFilter === 'high-density') {
                filtered = allRezonings.filter(r => r.type === 'high-density');
            } else if (currentFilter === 'lotsplit') {
                filtered = allRezonings.filter(r => r.type === 'lotsplit');
            } else if (currentFilter === 'approved') {
                filtered = approvedRezonings;
                total = approvedRezonings.length;
                countLabel = 'approved (last 2 years)';
            }

            document.getElementById('rezoning-count').textContent = `${filtered.length} ${countLabel}`;
            document.getElementById('all-rezonings').innerHTML = filtered.length > 0 ?
                filtered.slice(0, 50).map(r => renderRezoningCard(r)).join('') :
                '<p class="text-slate-500 text-sm p-4">No rezonings match filter</p>';
            lucide.createIcons();
        }

        function renderNearbyRezonings() {
            document.getElementById('nearby-rezonings').innerHTML = nearbyRezonings.length > 0 ?
                nearbyRezonings.map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4">No rezonings within 3 miles</p>';
            lucide.createIcons();
        }

        function renderSales() {
            let filtered = allSales;
            if (currentSalesFilter === 'llc') filtered = allSales.filter(s => s.isLLC);

            document.getElementById('sales-count').textContent = `${filtered.length} sales • Source: ${allSales[0]?.source || 'POLARIS'}`;
            document.getElementById('sales-source').textContent = allSales[0]?.source === 'RentCast' ? 'Live data from RentCast API • Cached for 6 hours' : 'Use POLARIS link above for complete deed records';

            const emptyMessage = allSales.length === 0
                ? `<tr><td colspan="6" class="px-4 py-8 text-center">
                       <p class="text-slate-400 mb-2">RentCast API data unavailable (free tier: 50 calls/month)</p>
                       <p class="text-slate-500 text-sm">For complete sales data, click <strong>POLARIS Deeds</strong> above → search your street → click "Deeds" tab</p>
                   </td></tr>`
                : '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">No sales match filter</td></tr>';

            document.getElementById('sales-table').innerHTML = filtered.length > 0 ?
                filtered.map(s => `
                    <tr class="${s.isLLC ? 'bg-amber-950/10' : ''}">
                        <td class="px-4 py-3 font-semibold">${s.address}</td>
                        <td class="px-4 py-3 text-slate-300 text-sm">${s.buyer || '-'}</td>
                        <td class="px-4 py-3 text-emerald-400">${s.price}</td>
                        <td class="px-4 py-3 text-slate-400">${s.date}</td>
                        <td class="px-4 py-3 text-slate-400">${s.beds}/${s.baths}</td>
                        <td class="px-4 py-3">${s.isLLC ? '<span class="px-2 py-1 text-xs bg-amber-900/50 text-amber-300 rounded">LLC</span>' : ''}</td>
                    </tr>
                `).join('') : emptyMessage;
        }

        // ============================================
        // SEARCH FUNCTIONS
        // ============================================

        let searchTimeout = null;

        function handleSearch(query) {
            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(query), 150);

            // Show/hide clear button
            document.getElementById('search-clear').classList.toggle('hidden', !query);
        }

        function performSearch(query) {
            const resultsContainer = document.getElementById('search-results');

            if (!query || query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }

            const q = query.toLowerCase();

            // Search through all rezonings (active + approved)
            const allSearchable = [...allRezonings, ...approvedRezonings];
            const matches = allSearchable.filter(r => {
                const searchText = [
                    r.petition,
                    r.address,
                    r.petitioner,
                    r.currentZoning,
                    r.proposedZoning,
                    r.proposedUse,
                    r.description
                ].filter(Boolean).join(' ').toLowerCase();

                return searchText.includes(q);
            });

            // Sort by distance (nearest first) if available, then by approved status (active first)
            matches.sort((a, b) => {
                // Active rezonings first
                if (a.isApproved && !b.isApproved) return 1;
                if (!a.isApproved && b.isApproved) return -1;
                // Then by distance
                return (a.distance || 999) - (b.distance || 999);
            });

            // Render results
            if (matches.length > 0) {
                resultsContainer.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-sm text-slate-400">Found <span class="text-amber-400 font-semibold">${matches.length}</span> matching rezonings</p>
                        <button onclick="clearSearch()" class="text-xs text-slate-500 hover:text-white">Clear</button>
                    </div>
                    <div class="space-y-3">
                        ${matches.slice(0, 10).map(r => renderSearchResult(r)).join('')}
                    </div>
                    ${matches.length > 10 ? `<p class="text-xs text-slate-500 mt-3 text-center">Showing 10 of ${matches.length} results. Be more specific to narrow down.</p>` : ''}
                `;
                resultsContainer.classList.remove('hidden');
            } else {
                // Check if they searched for a watched developer
                const isWatchedDev = WATCHED_DEVS.some(d => d.toLowerCase().includes(q) || q.includes(d.toLowerCase()));
                const watchedMsg = isWatchedDev
                    ? `<p class="text-emerald-400 text-sm mb-2">✓ "${query}" is on your watched list - no active or recently approved petitions found.</p>`
                    : '';

                resultsContainer.innerHTML = `
                    <div class="text-center py-4">
                        ${watchedMsg}
                        <p class="text-slate-400 mb-2">${isWatchedDev ? 'This developer has no active or recently approved rezoning petitions in Charlotte.' : `No rezonings found for "${query}"`}</p>
                        <p class="text-xs text-slate-500">Try: "Blue Azalea", "Hines", "Veer Homes", "Sharon View", or a petition # like "2024-059"</p>
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
            }

            lucide.createIcons();
        }

        function renderSearchResult(r) {
            const distanceBadge = r.distance ? `<span class="text-emerald-400">${r.distance.toFixed(1)} mi</span>` : '';
            const typeBadge = r.type === 'high-density' ? '<span class="px-1.5 py-0.5 text-xs bg-red-900/50 text-red-300 rounded">HIGH DENSITY</span>' :
                             r.type === 'lotsplit' ? '<span class="px-1.5 py-0.5 text-xs bg-amber-900/50 text-amber-300 rounded">LOT SPLIT</span>' : '';

            return `
                <div class="p-3 rounded-lg bg-slate-800/50 hover:bg-slate-800 transition-colors cursor-pointer" onclick="jumpToRezoning('${r.petition}')">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <span class="font-semibold text-amber-400 text-sm">Petition ${r.petition}</span>
                                ${typeBadge}
                                ${distanceBadge}
                            </div>
                            <p class="text-white text-sm truncate">${r.address || 'Location: see petition details'}</p>
                            <p class="text-xs text-slate-400 truncate">${r.description}</p>
                            <p class="text-xs text-slate-500 mt-1">Petitioner: ${r.petitioner}</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-500 flex-shrink-0"></i>
                    </div>
                </div>
            `;
        }

        function jumpToRezoning(petition) {
            // Clear search
            clearSearch();

            // Switch to All Rezonings tab
            showTab('rezonings');

            // Scroll to and highlight the rezoning
            setTimeout(() => {
                const cards = document.querySelectorAll('#all-rezonings > div');
                for (const card of cards) {
                    if (card.textContent.includes(`Petition ${petition}`)) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.classList.add('ring-2', 'ring-amber-500');
                        setTimeout(() => card.classList.remove('ring-2', 'ring-amber-500'), 3000);
                        break;
                    }
                }
            }, 100);
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('search-clear').classList.add('hidden');
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function scrollToSection(sectionId) {
            showTab('overview');
            setTimeout(() => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    section.classList.add('ring-2', 'ring-amber-500/50');
                    setTimeout(() => section.classList.remove('ring-2', 'ring-amber-500/50'), 2000);
                }
            }, 100);
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-amber-600', 'text-white');
                el.classList.add('text-slate-400');
            });
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabId}"]`).classList.remove('text-slate-400');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('bg-amber-600', 'text-white');
        }

        function filterRezonings(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(el => {
                el.classList.remove('bg-amber-600', 'text-white');
                el.classList.add('bg-slate-800', 'text-slate-400');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.remove('bg-slate-800', 'text-slate-400');
            document.querySelector(`[data-filter="${filter}"]`).classList.add('bg-amber-600', 'text-white');
            renderAllRezonings();
        }

        function filterSales(filter) {
            currentSalesFilter = filter;
            document.querySelectorAll('.sales-filter-btn').forEach(el => {
                el.classList.remove('bg-amber-600', 'text-white');
                el.classList.add('bg-slate-800', 'text-slate-400');
            });
            document.querySelector(`[data-sales-filter="${filter}"]`).classList.remove('bg-slate-800', 'text-slate-400');
            document.querySelector(`[data-sales-filter="${filter}"]`).classList.add('bg-amber-600', 'text-white');
            renderSales();
        }

        // ============================================
        // MAIN
        // ============================================

        async function refreshAllData() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('animate-spin');
            hideError();

            try {
                // Fetch active rezonings
                const features = await fetchRezonings();
                allRezonings = await processRezonings(features);

                // Fetch approved rezonings (last 2 years)
                const approvedFeatures = await fetchApprovedRezonings();
                approvedRezonings = await processApprovedRezonings(approvedFeatures);

                // Calculate distances for approved rezonings
                approvedRezonings.forEach(r => {
                    if (r.lat && r.lon) {
                        r.distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, r.lat, r.lon);
                    }
                });

                // Filter nearby for both active and approved
                nearbyRezonings = filterNearby(allRezonings);
                nearbyApproved = approvedRezonings.filter(r => r.distance && r.distance <= SEARCH_RADIUS_MILES)
                    .sort((a, b) => (a.distance || 999) - (b.distance || 999));

                // Enrich with addresses
                await enrichWithAddresses(allRezonings);
                await enrichWithAddresses(approvedRezonings);

                // Fetch sales
                allSales = await fetchSalesData();

                // Render everything
                renderOverview();
                renderAllRezonings();
                renderNearbyRezonings();
                renderSales();

                document.getElementById('last-updated').textContent = `Updated: ${new Date().toLocaleString()}`;
            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            }

            refreshIcon.classList.remove('animate-spin');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            refreshAllData();
        });
    </script>
</body>
</html>
