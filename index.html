<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mammoth Oaks / Lansdowne Development Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'JetBrains Mono', monospace; }
        .loading-shimmer {
            background: linear-gradient(90deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- Header -->
    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                        <i data-lucide="home" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight">Mammoth Oaks / Lansdowne</h1>
                        <p class="text-xs text-slate-500 tracking-wide">DEVELOPMENT TRACKER • 28270</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="refreshAllData()" class="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors text-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4" id="refresh-icon"></i>
                        Refresh
                    </button>
                    <div class="text-xs text-slate-500" id="last-updated">Loading...</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Error Banner -->
        <div id="error-banner" class="hidden mb-6 p-4 rounded-lg bg-gradient-to-r from-red-950/50 to-red-900/30 border border-red-800/50">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                <div>
                    <p class="font-semibold text-red-300">Error Loading Data</p>
                    <p class="text-sm text-red-400/80" id="error-message"></p>
                </div>
            </div>
        </div>

        <!-- Alert Banner -->
        <div id="alert-banner" class="hidden mb-6 p-4 rounded-lg bg-gradient-to-r from-red-950/50 to-orange-950/50 border border-red-800/50">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400"></i>
                <div>
                    <p class="font-semibold text-red-300" id="alert-count">Loading...</p>
                    <p class="text-sm text-red-400/80">Active rezoning petitions near your neighborhood</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="file-text" class="w-4 h-4 text-amber-500"></i>
                    <span class="text-xs text-slate-500">ACTIVE</span>
                </div>
                <div class="text-2xl font-bold" id="stat-rezonings">-</div>
                <div class="text-xs text-slate-500">Rezoning Petitions</div>
            </div>
            <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="building-2" class="w-4 h-4 text-red-500"></i>
                    <span class="text-xs text-slate-500">ALERT</span>
                </div>
                <div class="text-2xl font-bold" id="stat-critical">-</div>
                <div class="text-xs text-slate-500">High-Density</div>
            </div>
            <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="scissors" class="w-4 h-4 text-amber-500"></i>
                    <span class="text-xs text-slate-500">WATCH</span>
                </div>
                <div class="text-2xl font-bold" id="stat-lotsplits">-</div>
                <div class="text-xs text-slate-500">Lot Splits</div>
            </div>
            <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="map-pin" class="w-4 h-4 text-emerald-500"></i>
                    <span class="text-xs text-slate-500">NEARBY</span>
                </div>
                <div class="text-2xl font-bold" id="stat-nearby">-</div>
                <div class="text-xs text-slate-500">Within 3 Miles</div>
            </div>
            <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="dollar-sign" class="w-4 h-4 text-blue-500"></i>
                    <span class="text-xs text-slate-500">TRACKED</span>
                </div>
                <div class="text-2xl font-bold" id="stat-sales">-</div>
                <div class="text-xs text-slate-500">Recent Sales</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-1 mb-6 p-1 bg-slate-900 rounded-lg w-fit flex-wrap">
            <button onclick="showTab('overview')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all bg-amber-600 text-white" data-tab="overview">Overview</button>
            <button onclick="showTab('rezonings')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all text-slate-400 hover:text-white hover:bg-slate-800" data-tab="rezonings">All Rezonings</button>
            <button onclick="showTab('nearby')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all text-slate-400 hover:text-white hover:bg-slate-800" data-tab="nearby">Near Us</button>
            <button onclick="showTab('sales')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all text-slate-400 hover:text-white hover:bg-slate-800" data-tab="sales">Property Sales</button>
            <button onclick="showTab('settings')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all text-slate-400 hover:text-white hover:bg-slate-800" data-tab="settings">Settings</button>
            <button onclick="showTab('action')" class="tab-btn px-4 py-2 text-sm rounded-md transition-all text-slate-400 hover:text-white hover:bg-slate-800" data-tab="action">Take Action</button>
        </div>

        <!-- Tab: Overview -->
        <div id="tab-overview" class="tab-content">
            <div class="space-y-6">
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-4 h-4 text-red-400"></i>
                        HIGH DENSITY PROJECTS NEAR YOU
                    </h2>
                    <div id="critical-alerts" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-lg"></div>
                    </div>
                </section>
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="scissors" class="w-4 h-4 text-amber-400"></i>
                        LOT SPLITS NEAR YOU
                    </h2>
                    <div id="lotsplit-overview" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-lg"></div>
                    </div>
                </section>
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-4 h-4 text-emerald-400"></i>
                        ALL NEARBY REZONINGS (3 MILES)
                    </h2>
                    <div id="nearby-overview" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-lg"></div>
                    </div>
                </section>
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="dollar-sign" class="w-4 h-4 text-blue-400"></i>
                        RECENT SALES & LLC PURCHASES
                    </h2>
                    <div id="sales-overview" class="space-y-3">
                        <p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">
                            Loading sales data...
                        </p>
                    </div>
                </section>
            </div>
        </div>

        <!-- Tab: All Rezonings -->
        <div id="tab-rezonings" class="tab-content hidden">
            <div class="mb-4 flex items-center gap-4 flex-wrap">
                <div class="flex gap-2">
                    <button onclick="filterRezonings('all')" class="filter-btn px-3 py-1.5 text-xs rounded-lg bg-amber-600 text-white" data-filter="all">All</button>
                    <button onclick="filterRezonings('high-density')" class="filter-btn px-3 py-1.5 text-xs rounded-lg bg-slate-800 text-slate-400" data-filter="high-density">High-Density</button>
                    <button onclick="filterRezonings('lotsplit')" class="filter-btn px-3 py-1.5 text-xs rounded-lg bg-slate-800 text-slate-400" data-filter="lotsplit">Lot Splits</button>
                </div>
                <div class="text-xs text-slate-500" id="rezoning-count">Loading...</div>
            </div>
            <div id="all-rezonings" class="space-y-4">
                <div class="loading-shimmer h-32 rounded-lg"></div>
            </div>
        </div>

        <!-- Tab: Nearby -->
        <div id="tab-nearby" class="tab-content hidden">
            <div class="mb-4 p-4 rounded-lg bg-slate-900 border border-slate-800">
                <p class="text-sm text-slate-400">Rezonings within <span class="text-amber-400 font-semibold">3 miles</span> of Mammoth Oaks (35.1328°N, 80.8140°W)</p>
            </div>
            <div id="nearby-rezonings" class="space-y-4">
                <div class="loading-shimmer h-32 rounded-lg"></div>
            </div>
        </div>

        <!-- Tab: Sales -->
        <div id="tab-sales" class="tab-content hidden">
            <div class="mb-4 flex items-center justify-between flex-wrap gap-4">
                <div>
                    <p class="text-sm text-slate-400">Recent property sales in 28270 - LLC purchases flagged</p>
                    <p class="text-xs text-slate-500 mt-1" id="sales-source">Data refreshes automatically</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="filterSales('all')" class="sales-filter-btn px-3 py-1.5 text-xs rounded-lg bg-amber-600 text-white" data-sales-filter="all">All</button>
                    <button onclick="filterSales('llc')" class="sales-filter-btn px-3 py-1.5 text-xs rounded-lg bg-slate-800 text-slate-400" data-sales-filter="llc">LLC Only</button>
                    <a href="https://polaris3g.mecklenburgcountync.gov/" target="_blank" class="px-3 py-1.5 text-xs rounded-lg bg-blue-900/50 text-blue-300 hover:bg-blue-800/50 flex items-center gap-1">
                        POLARIS Deeds <i data-lucide="external-link" class="w-3 h-3"></i>
                    </a>
                </div>
            </div>
            <div class="mb-4 p-3 rounded-lg bg-blue-950/30 border border-blue-800/30 text-xs">
                <p class="text-blue-300"><strong>Note:</strong> Sales data from RentCast may not include all recent transactions. For complete deed records, use
                    <a href="https://polaris3g.mecklenburgcountync.gov/" target="_blank" class="text-blue-400 hover:underline">Mecklenburg POLARIS</a>
                    → Search by address or parcel → "Deeds" tab. This shows ALL recorded sales from county records.
                </p>
            </div>
            <div class="overflow-x-auto rounded-lg border border-slate-800">
                <table class="w-full">
                    <thead class="bg-slate-900">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">ADDRESS</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">BUYER</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">PRICE</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">SOLD</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">BEDS/BATHS</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400">FLAGS</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table" class="divide-y divide-slate-800">
                        <tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">Loading sales data...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-xs text-slate-500" id="sales-count">0 sales</div>
        </div>

        <!-- Tab: Take Action -->
        <div id="tab-action" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Upcoming Hearings -->
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4 text-red-400"></i>
                        UPCOMING HEARINGS NEAR YOU
                    </h2>
                    <div id="upcoming-hearings" class="space-y-3">
                        <div class="loading-shimmer h-24 rounded-lg"></div>
                    </div>
                </section>

                <!-- How to Oppose -->
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="shield" class="w-4 h-4 text-amber-400"></i>
                        HOW TO OPPOSE A REZONING
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="p-4 rounded-lg bg-gradient-to-br from-red-950/40 to-red-900/20 border border-red-800/50">
                            <h3 class="font-semibold text-red-300 mb-2 flex items-center gap-2">
                                <i data-lucide="users" class="w-4 h-4"></i>
                                The 20% Protest Petition Rule
                            </h3>
                            <p class="text-sm text-slate-300 mb-3">
                                If owners of <strong>20% or more</strong> of the land within 100 feet of a rezoning petition sign a written protest,
                                the rezoning requires a <strong>3/4 supermajority</strong> (9 of 11 votes) instead of a simple majority to pass.
                            </p>
                            <p class="text-xs text-slate-400">This is your most powerful tool. Coordinate with adjacent neighbors!</p>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                            <h3 class="font-semibold text-slate-300 mb-2 flex items-center gap-2">
                                <i data-lucide="message-square" class="w-4 h-4"></i>
                                Speak at the Public Hearing
                            </h3>
                            <p class="text-sm text-slate-400 mb-2">
                                Every rezoning has a public hearing. You get 3 minutes to speak. Key points to make:
                            </p>
                            <ul class="text-xs text-slate-400 space-y-1 list-disc list-inside">
                                <li>Traffic and infrastructure impacts</li>
                                <li>Incompatibility with existing neighborhood character</li>
                                <li>Stormwater/drainage concerns</li>
                                <li>Tree canopy loss</li>
                            </ul>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                            <h3 class="font-semibold text-slate-300 mb-2 flex items-center gap-2">
                                <i data-lucide="mail" class="w-4 h-4"></i>
                                Submit Written Comments
                            </h3>
                            <p class="text-sm text-slate-400 mb-3">
                                Email comments become part of the public record. Send to both Planning and your District Rep.
                            </p>
                            <a href="mailto:rezoning@charlottenc.gov" class="inline-block px-3 py-1.5 bg-blue-900/50 text-blue-300 rounded text-xs hover:bg-blue-800/50">
                                rezoning@charlottenc.gov
                            </a>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                            <h3 class="font-semibold text-slate-300 mb-2 flex items-center gap-2">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                Request a Community Meeting
                            </h3>
                            <p class="text-sm text-slate-400">
                                Petitioners are required to hold a community meeting before the hearing.
                                Attend and ask hard questions about density, traffic studies, and tree preservation.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Key Contacts -->
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="phone" class="w-4 h-4 text-emerald-400"></i>
                        KEY CONTACTS FOR DISTRICT 7 (28270)
                    </h2>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                            <p class="text-xs text-slate-500 mb-1">CITY COUNCIL DISTRICT 7</p>
                            <p class="font-semibold text-white">Check charlottenc.gov for current rep</p>
                            <a href="https://charlottenc.gov/CityCouncil" target="_blank" class="text-blue-400 text-xs hover:underline">City Council Directory →</a>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                            <p class="text-xs text-slate-500 mb-1">PLANNING DEPARTMENT</p>
                            <p class="font-semibold text-white">(704) 336-2205</p>
                            <a href="mailto:rezoning@charlottenc.gov" class="text-blue-400 text-xs hover:underline">rezoning@charlottenc.gov</a>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                            <p class="text-xs text-slate-500 mb-1">ZONING ENFORCEMENT</p>
                            <p class="font-semibold text-white">(704) 336-2205</p>
                            <p class="text-xs text-slate-400">Report violations of approved conditions</p>
                        </div>
                    </div>
                </section>

                <!-- Developer Activity -->
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 text-purple-400"></i>
                        DEVELOPER ACTIVITY SCORECARD
                    </h2>
                    <div id="developer-scorecard" class="space-y-2">
                        <div class="loading-shimmer h-32 rounded-lg"></div>
                    </div>
                </section>

                <!-- Zoning Decoder -->
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="book-open" class="w-4 h-4 text-blue-400"></i>
                        ZONING CODE DECODER
                    </h2>
                    <div class="grid md:grid-cols-2 gap-3">
                        <div class="p-3 rounded-lg bg-red-950/30 border border-red-800/30">
                            <span class="font-mono font-bold text-red-400">N2-A, N2-B</span>
                            <p class="text-xs text-slate-400 mt-1">High-density attached housing. Townhomes, duplexes. 8-17 units/acre. <strong class="text-red-300">Major density increase.</strong></p>
                        </div>
                        <div class="p-3 rounded-lg bg-red-950/30 border border-red-800/30">
                            <span class="font-mono font-bold text-red-400">UR-2, UR-3</span>
                            <p class="text-xs text-slate-400 mt-1">Urban Residential. Multi-family apartments, condos. 12-22+ units/acre. <strong class="text-red-300">Highest density.</strong></p>
                        </div>
                        <div class="p-3 rounded-lg bg-amber-950/30 border border-amber-800/30">
                            <span class="font-mono font-bold text-amber-400">N1-C</span>
                            <p class="text-xs text-slate-400 mt-1">Neighborhood 1 - C. Allows <strong class="text-amber-300">lot splits</strong>. One lot becomes 2-3 smaller lots with smaller homes.</p>
                        </div>
                        <div class="p-3 rounded-lg bg-amber-950/30 border border-amber-800/30">
                            <span class="font-mono font-bold text-amber-400">TOD, MUDD</span>
                            <p class="text-xs text-slate-400 mt-1">Transit-Oriented / Mixed-Use. Very high density allowed. Apartments + retail.</p>
                        </div>
                        <div class="p-3 rounded-lg bg-emerald-950/30 border border-emerald-800/30">
                            <span class="font-mono font-bold text-emerald-400">N1-A, N1-B</span>
                            <p class="text-xs text-slate-400 mt-1">Neighborhood 1. Single-family only. <strong class="text-emerald-300">This is what you want to protect.</strong></p>
                        </div>
                        <div class="p-3 rounded-lg bg-emerald-950/30 border border-emerald-800/30">
                            <span class="font-mono font-bold text-emerald-400">R-3, R-4</span>
                            <p class="text-xs text-slate-400 mt-1">Legacy single-family residential. Lower density. Existing neighborhood character.</p>
                        </div>
                    </div>
                </section>

                <!-- Export -->
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4 text-slate-400"></i>
                        EXPORT FOR HOA MEETING
                    </h2>
                    <div class="flex gap-3">
                        <button onclick="exportSummary()" class="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-semibold flex items-center gap-2">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                            Print Summary Report
                        </button>
                        <button onclick="copyEmailDraft()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm flex items-center gap-2">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            Copy Email Template
                        </button>
                    </div>
                </section>

                <!-- Useful Links -->
                <section>
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 tracking-wide flex items-center gap-2">
                        <i data-lucide="link" class="w-4 h-4 text-slate-400"></i>
                        USEFUL RESOURCES
                    </h2>
                    <div class="grid md:grid-cols-3 gap-3">
                        <a href="https://charlottenc.gov/planning/Rezoning/Pages/default.aspx" target="_blank" class="p-3 rounded-lg bg-slate-900 border border-slate-800 hover:border-slate-600 transition-colors">
                            <p class="font-semibold text-sm text-white flex items-center gap-2">Rezoning Calendar <i data-lucide="external-link" class="w-3 h-3"></i></p>
                            <p class="text-xs text-slate-500">Hearing dates and deadlines</p>
                        </a>
                        <a href="https://rezoning.org" target="_blank" class="p-3 rounded-lg bg-slate-900 border border-slate-800 hover:border-slate-600 transition-colors">
                            <p class="font-semibold text-sm text-white flex items-center gap-2">Rezoning.org <i data-lucide="external-link" class="w-3 h-3"></i></p>
                            <p class="text-xs text-slate-500">Detailed petition info & maps</p>
                        </a>
                        <a href="https://polaris3g.mecklenburgcountync.gov/" target="_blank" class="p-3 rounded-lg bg-slate-900 border border-slate-800 hover:border-slate-600 transition-colors">
                            <p class="font-semibold text-sm text-white flex items-center gap-2">POLARIS GIS <i data-lucide="external-link" class="w-3 h-3"></i></p>
                            <p class="text-xs text-slate-500">Property records & ownership</p>
                        </a>
                        <a href="https://charlottenc.gov/planning/Subdivision/Pages/default.aspx" target="_blank" class="p-3 rounded-lg bg-slate-900 border border-slate-800 hover:border-slate-600 transition-colors">
                            <p class="font-semibold text-sm text-white flex items-center gap-2">Subdivision Info <i data-lucide="external-link" class="w-3 h-3"></i></p>
                            <p class="text-xs text-slate-500">Lot split regulations</p>
                        </a>
                        <a href="https://charlottenc.gov/Trees/Pages/default.aspx" target="_blank" class="p-3 rounded-lg bg-slate-900 border border-slate-800 hover:border-slate-600 transition-colors">
                            <p class="font-semibold text-sm text-white flex items-center gap-2">Tree Ordinance <i data-lucide="external-link" class="w-3 h-3"></i></p>
                            <p class="text-xs text-slate-500">Tree save requirements</p>
                        </a>
                        <a href="https://ww.ncdot.gov/projects/public-meetings/" target="_blank" class="p-3 rounded-lg bg-slate-900 border border-slate-800 hover:border-slate-600 transition-colors">
                            <p class="font-semibold text-sm text-white flex items-center gap-2">NCDOT Projects <i data-lucide="external-link" class="w-3 h-3"></i></p>
                            <p class="text-xs text-slate-500">Road & traffic studies</p>
                        </a>
                    </div>
                </section>
            </div>
        </div>

        <!-- Tab: Settings -->
        <div id="tab-settings" class="tab-content hidden">
            <div class="space-y-6">
                <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                    <h3 class="text-sm font-semibold text-slate-300 mb-3">API Configuration</h3>
                    <p class="text-xs text-slate-500 mb-4">
                        Sales data is provided by RentCast API. A built-in key is included (shared 50 calls/month).
                        For dedicated usage, get your own free key at
                        <a href="https://www.rentcast.io/api" target="_blank" class="text-blue-400 hover:underline">rentcast.io/api</a>
                    </p>
                    <div class="flex gap-2">
                        <input type="password" id="api-key-input" placeholder="Enter RentCast API key..."
                               class="flex-1 px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:border-amber-500 focus:outline-none">
                        <button onclick="saveApiKey()" class="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-semibold">Save</button>
                    </div>
                    <p class="text-xs text-slate-500 mt-2" id="api-key-status"></p>
                </div>

                <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                    <h3 class="text-sm font-semibold text-slate-300 mb-3">Watched Developers</h3>
                    <p class="text-xs text-slate-500 mb-3">These developers are flagged when they appear in rezoning petitions:</p>
                    <div class="flex gap-2 flex-wrap">
                        <span class="px-2 py-1 bg-purple-900/30 text-purple-300 rounded text-xs">Veer Homes</span>
                        <span class="px-2 py-1 bg-purple-900/30 text-purple-300 rounded text-xs">THR Design Build</span>
                        <span class="px-2 py-1 bg-purple-900/30 text-purple-300 rounded text-xs">Pike Properties</span>
                        <span class="px-2 py-1 bg-purple-900/30 text-purple-300 rounded text-xs">Northway Homes</span>
                        <span class="px-2 py-1 bg-purple-900/30 text-purple-300 rounded text-xs">Sinacori</span>
                        <span class="px-2 py-1 bg-purple-900/30 text-purple-300 rounded text-xs">Epic Homes</span>
                        <span class="px-2 py-1 bg-purple-900/30 text-purple-300 rounded text-xs">Forte Builders</span>
                    </div>
                </div>

                <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                    <h3 class="text-sm font-semibold text-slate-300 mb-3">Data Sources</h3>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Rezoning Data</span>
                            <a href="https://gis.charlottenc.gov/arcgis/rest/services/PLN/Rezonings/MapServer/0" target="_blank" class="text-blue-400 hover:underline">Charlotte ArcGIS</a>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Address Lookup</span>
                            <a href="https://gis.charlottenc.gov/arcgis/rest/services/CountyData/MasterAddress/MapServer/0" target="_blank" class="text-blue-400 hover:underline">Charlotte MasterAddress</a>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Property Records</span>
                            <a href="https://polaris3g.mecklenburgcountync.gov/" target="_blank" class="text-blue-400 hover:underline">Mecklenburg POLARIS</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="border-t border-slate-800 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-slate-500">
            Data from Charlotte Planning ArcGIS • Mecklenburg County POLARIS • Updated automatically
        </div>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const NEIGHBORHOOD_CENTER = { lat: 35.1328, lon: -80.8140 };
        const SEARCH_RADIUS_MILES = 3;
        const ZIP_CODE = '28270';

        // APIs
        const REZONING_API = 'https://gis.charlottenc.gov/arcgis/rest/services/PLN/Rezonings/MapServer/0/query';
        const ADDRESS_API = 'https://gis.charlottenc.gov/arcgis/rest/services/CountyData/MasterAddress/MapServer/0/query';

        // Keywords
        const HIGH_DENSITY = ['townhome', 'townhouse', 'multi-family', 'multifamily', 'attached', 'N2-A', 'N2-B', 'UR-2', 'UR-3', 'apartment', 'condo', 'duplex', 'triplex', 'MF', 'TOD', 'MUDD'];
        const LOTSPLIT = ['N1-C', 'subdivision', 'split', 'two lot', '2 lot'];
        const WATCHED_DEVS = ['Veer Homes', 'THR Design', 'THR Build', 'Pike Properties', 'Northway', 'Sinacori', 'Epic Homes', 'Forte Builders', 'DR Horton', 'Lennar', 'Pulte', 'Meritage'];
        const LLC_PATTERNS = ['LLC', 'L.L.C.', 'LP', 'L.P.', 'INC', 'CORP', 'HOLDINGS', 'INVESTMENTS', 'DEVELOPMENT', 'PROPERTIES', 'VENTURES', 'CAPITAL', 'PARTNERS', 'GROUP', 'TRUST'];

        // Storage
        const API_KEY_STORAGE = 'mammoth_oaks_api_key';
        const SALES_CACHE = 'mammoth_oaks_sales_cache';
        const ADDRESS_CACHE = 'mammoth_oaks_address_cache';

        // Default API key (RentCast free tier - 50 calls/month)
        const DEFAULT_RENTCAST_KEY = '8b894ad1348e4918ae3443328dadc07a';

        // State
        let allRezonings = [];
        let nearbyRezonings = [];
        let allSales = [];
        let addressCache = {};
        let currentFilter = 'all';
        let currentSalesFilter = 'all';

        // ============================================
        // ZONING TRANSLATOR - Plain English descriptions
        // ============================================

        function getZoningDescription(code) {
            if (!code || code === '-') return 'Unknown';
            const c = code.toUpperCase().replace(/\(CD\)|\(SPA\)|\(LLWPA\)/g, '').trim();

            // Single-family residential (good)
            if (/^R-3|^R-4|^R-5|^R-6|^R-8|^R-MH/.test(c)) return 'Single-family homes';
            if (/^N1-A|^N1-B/.test(c)) return 'Single-family homes';
            if (/^RE-1|^RE-2|^RE-3/.test(c)) return 'Large lot single-family';

            // Lot splits (warning)
            if (/^N1-C/.test(c)) return 'Lot splits allowed (2-3 homes per lot)';

            // Attached/Townhomes (high density)
            if (/^N1-D|^N1-E/.test(c)) return 'Small lot single-family or duplexes';
            if (/^N2-A/.test(c)) return 'Townhomes & duplexes (8-12 units/acre)';
            if (/^N2-B/.test(c)) return 'Townhomes & triplexes (12-17 units/acre)';

            // Multi-family (highest density)
            if (/^UR-1/.test(c)) return 'Urban residential (8-12 units/acre)';
            if (/^UR-2/.test(c)) return 'Apartments & condos (12-18 units/acre)';
            if (/^UR-3/.test(c)) return 'High-rise apartments (18-22+ units/acre)';
            if (/^MF/.test(c)) return 'Multi-family apartments';

            // Mixed-use (very high density)
            if (/^TOD/.test(c)) return 'Transit-oriented (apartments + retail)';
            if (/^MUDD/.test(c)) return 'Mixed-use (apartments + commercial)';
            if (/^MX/.test(c)) return 'Mixed-use development';
            if (/^CC/.test(c)) return 'Commercial center';
            if (/^TS/.test(c)) return 'Transit station area';

            // Commercial/Industrial
            if (/^B-1|^B-2|^NS|^O-1|^O-2/.test(c)) return 'Commercial/Office';
            if (/^I-1|^I-2/.test(c)) return 'Industrial';
            if (/^INST/.test(c)) return 'Institutional';

            // Legacy codes
            if (/^R-17MF|^R-22MF|^R-43MF/.test(c)) return 'Multi-family apartments';
            if (/^R-12MF/.test(c)) return 'Townhomes/apartments';

            return code; // Return original if unknown
        }

        function getZoningChangeDescription(fromZone, toZone) {
            const from = getZoningDescription(fromZone);
            const to = getZoningDescription(toZone);

            if (from === to) return null;
            return `${from} → ${to}`;
        }

        // ============================================
        // API FUNCTIONS
        // ============================================

        async function fetchRezonings() {
            const params = new URLSearchParams({
                where: '1=1',
                outFields: '*',
                f: 'json',
                returnGeometry: 'true',
                outSR: '4326'
            });
            const response = await fetch(`${REZONING_API}?${params}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.features || [];
        }

        async function lookupAddress(lat, lon) {
            // Check cache first
            const cacheKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;
            if (addressCache[cacheKey]) return addressCache[cacheKey];

            try {
                // Query addresses within ~500ft of the point
                const buffer = 0.002; // ~0.002 degrees ≈ 700ft
                const params = new URLSearchParams({
                    where: '1=1',
                    geometry: JSON.stringify({
                        xmin: lon - buffer,
                        ymin: lat - buffer,
                        xmax: lon + buffer,
                        ymax: lat + buffer,
                        spatialReference: { wkid: 4326 }
                    }),
                    geometryType: 'esriGeometryEnvelope',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: 'FullAddress,ZipCode',
                    returnGeometry: 'false',
                    f: 'json',
                    resultRecordCount: 1
                });

                const response = await fetch(`${ADDRESS_API}?${params}`);
                if (!response.ok) return null;

                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    const addr = data.features[0].attributes.FullAddress;
                    addressCache[cacheKey] = addr;
                    // Save cache
                    localStorage.setItem(ADDRESS_CACHE, JSON.stringify(addressCache));
                    return addr;
                }
            } catch (e) {
                console.error('Address lookup error:', e);
            }
            return null;
        }

        async function fetchSalesData() {
            const apiKey = localStorage.getItem(API_KEY_STORAGE) || DEFAULT_RENTCAST_KEY;
            let allResults = [];

            if (apiKey) {
                try {
                    // Try multiple approaches to get comprehensive sales data

                    // 1. First try the properties endpoint for the local area (most accurate for recent sales)
                    const searchAddresses = ['Preston', 'Lansdowne', 'Mammoth', 'Lansing'];

                    for (const street of searchAddresses) {
                        try {
                            const propResponse = await fetch(`https://api.rentcast.io/v1/properties?city=Charlotte&state=NC&zipCode=${ZIP_CODE}&address=${encodeURIComponent(street)}&limit=10`, {
                                headers: { 'X-Api-Key': apiKey }
                            });
                            if (propResponse.ok) {
                                const propData = await propResponse.json();
                                if (propData && propData.length > 0) {
                                    for (const prop of propData) {
                                        if (prop.lastSaleDate) {
                                            allResults.push({
                                                address: prop.formattedAddress || prop.addressLine1,
                                                price: prop.lastSalePrice ? `$${prop.lastSalePrice.toLocaleString()}` : 'N/A',
                                                priceNum: prop.lastSalePrice || 0,
                                                date: prop.lastSaleDate || 'Recent',
                                                beds: prop.bedrooms || '-',
                                                baths: prop.bathrooms || '-',
                                                sqft: prop.squareFootage ? prop.squareFootage.toLocaleString() : '-',
                                                buyer: prop.ownerName || '',
                                                isLLC: LLC_PATTERNS.some(pat => ((prop.ownerName || '') + ' ' + (prop.formattedAddress || '')).toUpperCase().includes(pat)),
                                                isWatched: WATCHED_DEVS.some(d => ((prop.ownerName || '') + ' ' + (prop.formattedAddress || '')).toLowerCase().includes(d.toLowerCase())),
                                                source: 'RentCast'
                                            });
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.log(`Street search for ${street} failed:`, e);
                        }
                    }

                    // 2. Also get general listings/sale data for the ZIP
                    const response = await fetch(`https://api.rentcast.io/v1/listings/sale?zipCode=${ZIP_CODE}&status=Sold&limit=50`, {
                        headers: { 'X-Api-Key': apiKey }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            const listingSales = data.map(p => ({
                                address: p.formattedAddress || p.addressLine1,
                                price: p.price ? `$${p.price.toLocaleString()}` : 'N/A',
                                priceNum: p.price || 0,
                                date: p.listedDate || p.lastSeen || 'Recent',
                                beds: p.bedrooms || '-',
                                baths: p.bathrooms || '-',
                                sqft: p.squareFootage ? p.squareFootage.toLocaleString() : '-',
                                buyer: '',
                                isLLC: LLC_PATTERNS.some(pat => (p.formattedAddress || '').toUpperCase().includes(pat)),
                                isWatched: WATCHED_DEVS.some(d => (p.formattedAddress || '').toLowerCase().includes(d.toLowerCase())),
                                source: 'RentCast'
                            }));
                            allResults = allResults.concat(listingSales);
                        }
                    }

                    // Deduplicate by address
                    const seen = new Set();
                    allResults = allResults.filter(s => {
                        const key = s.address?.toLowerCase().replace(/[^a-z0-9]/g, '');
                        if (seen.has(key)) return false;
                        seen.add(key);
                        return true;
                    });

                    // Sort by date (most recent first)
                    allResults.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateB - dateA;
                    });

                    if (allResults.length > 0) {
                        localStorage.setItem(SALES_CACHE, JSON.stringify({ timestamp: Date.now(), sales: allResults }));
                        return allResults;
                    }
                } catch (e) {
                    console.error('RentCast API error:', e);
                }
            }

            // Fallback: Use cached data
            const cached = localStorage.getItem(SALES_CACHE);
            if (cached) {
                const { timestamp, sales } = JSON.parse(cached);
                // Use cache if less than 24 hours old
                if (Date.now() - timestamp < 86400000) {
                    return sales;
                }
            }

            // Return sample/demo data for 28270
            return getSampleSalesData();
        }

        function getSampleSalesData() {
            // No sample data - return empty array when API unavailable
            return [];
        }

        // ============================================
        // DATA PROCESSING
        // ============================================

        async function processRezonings(features) {
            const results = [];

            for (const f of features) {
                const a = f.attributes;
                const geom = f.geometry;

                // Calculate centroid
                let lat = null, lon = null;
                if (geom && geom.rings && geom.rings[0]) {
                    const ring = geom.rings[0];
                    lon = ring.reduce((sum, pt) => sum + pt[0], 0) / ring.length;
                    lat = ring.reduce((sum, pt) => sum + pt[1], 0) / ring.length;
                }

                // Get zoning info
                const existZone = a.ExistZone || '-';
                const reqZone = a.ReqZone || '-';
                const propLuse = a.Propluse || '';

                // Determine type
                const allText = `${existZone} ${reqZone} ${propLuse} ${a.Petitioner || ''}`.toLowerCase();
                let type = 'other';
                if (HIGH_DENSITY.some(kw => allText.includes(kw.toLowerCase()))) {
                    type = 'high-density';
                } else if (LOTSPLIT.some(kw => allText.includes(kw.toLowerCase()))) {
                    type = 'lotsplit';
                }

                // Check for watched developers
                const petitioner = a.Petitioner || '';
                const isWatched = WATCHED_DEVS.some(dev => petitioner.toLowerCase().includes(dev.toLowerCase()));

                // Build description
                let description = `Rezone from ${existZone} to ${reqZone}`;
                if (propLuse) description += ` for ${propLuse}`;

                // Try to get hearing date if available
                let hearingDate = null;
                if (a.HearingDate) hearingDate = new Date(a.HearingDate).toLocaleDateString();
                else if (a.Hearing_Date) hearingDate = new Date(a.Hearing_Date).toLocaleDateString();
                else if (a.ZoningDate) hearingDate = new Date(a.ZoningDate).toLocaleDateString();

                results.push({
                    id: a.Petition || a.OBJECTID,
                    petition: a.Petition || 'Unknown',
                    petitioner: petitioner || 'Unknown',
                    currentZoning: existZone,
                    proposedZoning: reqZone,
                    proposedUse: propLuse,
                    status: a.Status || 'Pending',
                    description: description,
                    filedDate: a.Received ? new Date(a.Received).toLocaleDateString() : null,
                    hearingDate: hearingDate,
                    acres: a.Acres || a.PetAcres || null,
                    type: type,
                    isWatched: isWatched,
                    lat: lat,
                    lon: lon,
                    address: null, // Will be filled in
                    link: a.Hyperlink || `https://rezoning.org/petition/${a.Petition}`
                });
            }

            return results;
        }

        async function enrichWithAddresses(rezonings) {
            // Load address cache
            const cached = localStorage.getItem(ADDRESS_CACHE);
            if (cached) addressCache = JSON.parse(cached);

            // Calculate distances for all rezonings
            rezonings.forEach(r => {
                if (r.lat && r.lon) {
                    r.distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, r.lat, r.lon);
                }
            });

            // Lookup addresses for ALL rezonings with geometry (use cache to minimize API calls)
            const needsLookup = rezonings.filter(r => !r.address && r.lat && r.lon);

            // Process in batches to avoid overwhelming the API
            const batchSize = 10;
            for (let i = 0; i < Math.min(needsLookup.length, 50); i += batchSize) {
                const batch = needsLookup.slice(i, i + batchSize);
                const lookupPromises = batch.map(async r => {
                    r.address = await lookupAddress(r.lat, r.lon);
                    return r;
                });
                await Promise.all(lookupPromises);
            }

            return rezonings;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function filterNearby(rezonings) {
            return rezonings.filter(r => {
                if (!r.lat || !r.lon) return false;
                if (!r.distance) {
                    r.distance = calculateDistance(NEIGHBORHOOD_CENTER.lat, NEIGHBORHOOD_CENTER.lon, r.lat, r.lon);
                }
                return r.distance <= SEARCH_RADIUS_MILES;
            }).sort((a, b) => a.distance - b.distance);
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================

        function showError(message) {
            document.getElementById('error-banner').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        function hideError() {
            document.getElementById('error-banner').classList.add('hidden');
        }

        function renderRezoningCard(r, showDistance = false) {
            const bgColor = r.type === 'high-density' ? 'bg-red-950/30 border-red-800/50' :
                           r.type === 'lotsplit' ? 'bg-amber-950/30 border-amber-800/50' :
                           'bg-slate-900 border-slate-800';

            const typeBadge = r.type === 'high-density' ? '<span class="px-2 py-0.5 text-xs bg-red-900/50 text-red-300 rounded">HIGH DENSITY</span>' :
                             r.type === 'lotsplit' ? '<span class="px-2 py-0.5 text-xs bg-amber-900/50 text-amber-300 rounded">LOT SPLIT</span>' : '';

            const watchedBadge = r.isWatched ? '<span class="px-2 py-0.5 text-xs bg-purple-900/50 text-purple-300 rounded">WATCHED DEV</span>' : '';
            const distanceText = showDistance && r.distance ? `<span class="text-emerald-400 font-semibold">${r.distance.toFixed(1)} mi</span>` : '';

            // Show address if available, otherwise show petition number prominently
            const addressDisplay = r.address
                ? `<span class="font-semibold text-white">${r.address}</span>`
                : `<span class="text-slate-400">Location: see petition details</span>`;

            // Plain language zoning change description
            const plainChange = getZoningChangeDescription(r.currentZoning, r.proposedZoning);
            const plainChangeHtml = plainChange
                ? `<div class="mt-2 p-2 rounded bg-slate-800/50 border border-slate-700">
                       <p class="text-xs text-slate-500 mb-1">WHAT THIS MEANS:</p>
                       <p class="text-sm font-semibold text-white">${plainChange}</p>
                   </div>`
                : '';

            return `
                <div class="p-4 rounded-lg ${bgColor} border">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <span class="font-semibold text-amber-400">Petition ${r.petition}</span>
                                ${typeBadge}
                                ${watchedBadge}
                                <span class="px-2 py-0.5 text-xs bg-slate-700 text-slate-300 rounded">${r.status}</span>
                                ${distanceText ? `<span class="text-xs">${distanceText}</span>` : ''}
                            </div>
                            <div class="mb-2">${addressDisplay}</div>
                            ${plainChangeHtml}
                            <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-xs text-slate-500 mt-3">
                                <div>Petitioner: <span class="text-slate-300">${r.petitioner}</span></div>
                                <div>Acres: <span class="text-slate-300">${r.acres || '-'}</span></div>
                                <div>Current: <span class="text-slate-300">${r.currentZoning}</span> <span class="text-slate-600">(${getZoningDescription(r.currentZoning)})</span></div>
                                <div>Proposed: <span class="text-amber-400 font-semibold">${r.proposedZoning}</span> <span class="text-slate-600">(${getZoningDescription(r.proposedZoning)})</span></div>
                                ${r.filedDate ? `<div>Filed: <span class="text-slate-300">${r.filedDate}</span></div>` : ''}
                                ${r.hearingDate ? `<div>Hearing: <span class="text-red-400 font-semibold">${r.hearingDate}</span></div>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <a href="${r.link}" target="_blank" class="flex items-center gap-1 px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors text-xs whitespace-nowrap">
                                Details <i data-lucide="external-link" class="w-3 h-3"></i>
                            </a>
                            ${r.lat && r.lon ? `<a href="https://polaris3g.mecklenburgcountync.gov/xy/${Math.round(r.lon * 1000000)},${Math.round(r.lat * 1000000)}" target="_blank" class="flex items-center gap-1 px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors text-xs whitespace-nowrap">POLARIS <i data-lucide="external-link" class="w-3 h-3"></i></a>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOverview() {
            // High density nearby
            const criticalNearby = nearbyRezonings.filter(r => r.type === 'high-density');
            document.getElementById('critical-alerts').innerHTML = criticalNearby.length > 0 ?
                criticalNearby.map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">No high-density projects within 3 miles - great news!</p>';

            // Lot splits nearby
            const lotSplitsNearby = nearbyRezonings.filter(r => r.type === 'lotsplit');
            document.getElementById('lotsplit-overview').innerHTML = lotSplitsNearby.length > 0 ?
                lotSplitsNearby.map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">No lot split petitions within 3 miles</p>';

            // All nearby
            document.getElementById('nearby-overview').innerHTML = nearbyRezonings.length > 0 ?
                nearbyRezonings.slice(0, 10).map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">No rezonings within 3 miles</p>';

            // Sales
            const llcSales = allSales.filter(s => s.isLLC).slice(0, 5);
            document.getElementById('sales-overview').innerHTML = llcSales.length > 0 ?
                llcSales.map(s => `
                    <div class="p-3 bg-amber-950/30 border border-amber-800/50 rounded-lg flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-sm">${s.address}</div>
                            <div class="text-xs text-slate-400">${s.price} • ${s.date}</div>
                        </div>
                        <span class="px-2 py-0.5 text-xs bg-amber-900/50 text-amber-300 rounded">LLC</span>
                    </div>
                `).join('') :
                `<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">${allSales.length > 0 ? 'No LLC purchases detected in recent sales' : 'Loading sales data from RentCast...'}</p>`;

            // Stats
            document.getElementById('stat-rezonings').textContent = allRezonings.length;
            document.getElementById('stat-critical').textContent = allRezonings.filter(r => r.type === 'high-density').length;
            document.getElementById('stat-lotsplits').textContent = allRezonings.filter(r => r.type === 'lotsplit').length;
            document.getElementById('stat-nearby').textContent = nearbyRezonings.length;
            document.getElementById('stat-sales').textContent = allSales.length;

            // Alert banner
            const alertCount = criticalNearby.length + nearbyRezonings.filter(r => r.isWatched).length;
            if (alertCount > 0) {
                document.getElementById('alert-banner').classList.remove('hidden');
                document.getElementById('alert-count').textContent = `${alertCount} development projects require attention`;
            } else {
                document.getElementById('alert-banner').classList.add('hidden');
            }

            lucide.createIcons();
        }

        function renderAllRezonings() {
            let filtered = allRezonings;
            if (currentFilter === 'high-density') filtered = allRezonings.filter(r => r.type === 'high-density');
            if (currentFilter === 'lotsplit') filtered = allRezonings.filter(r => r.type === 'lotsplit');

            document.getElementById('rezoning-count').textContent = `${filtered.length} of ${allRezonings.length} petitions`;
            document.getElementById('all-rezonings').innerHTML = filtered.length > 0 ?
                filtered.slice(0, 50).map(r => renderRezoningCard(r)).join('') :
                '<p class="text-slate-500 text-sm p-4">No rezonings match filter</p>';
            lucide.createIcons();
        }

        function renderNearbyRezonings() {
            document.getElementById('nearby-rezonings').innerHTML = nearbyRezonings.length > 0 ?
                nearbyRezonings.map(r => renderRezoningCard(r, true)).join('') :
                '<p class="text-slate-500 text-sm p-4">No rezonings within 3 miles</p>';
            lucide.createIcons();
        }

        function renderSales() {
            let filtered = allSales;
            if (currentSalesFilter === 'llc') filtered = allSales.filter(s => s.isLLC);

            document.getElementById('sales-count').textContent = `${filtered.length} sales • Source: ${allSales[0]?.source || 'N/A'}`;
            document.getElementById('sales-source').textContent = allSales[0]?.source === 'RentCast' ? 'Live data from RentCast API • Updates on refresh' : 'No data available - check Settings for API configuration';

            document.getElementById('sales-table').innerHTML = filtered.length > 0 ?
                filtered.map(s => `
                    <tr class="${s.isLLC ? 'bg-amber-950/10' : ''}">
                        <td class="px-4 py-3 font-semibold">${s.address}</td>
                        <td class="px-4 py-3 text-slate-300 text-sm">${s.buyer || '-'}</td>
                        <td class="px-4 py-3 text-emerald-400">${s.price}</td>
                        <td class="px-4 py-3 text-slate-400">${s.date}</td>
                        <td class="px-4 py-3 text-slate-400">${s.beds}/${s.baths}</td>
                        <td class="px-4 py-3">${s.isLLC ? '<span class="px-2 py-1 text-xs bg-amber-900/50 text-amber-300 rounded">LLC</span>' : ''}</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">No sales match filter</td></tr>';
        }

        function renderUpcomingHearings() {
            // Find rezonings with hearing dates or active status that are nearby
            const withHearings = nearbyRezonings.filter(r => r.hearingDate || r.status?.toLowerCase().includes('hearing') || r.type === 'high-density');

            const container = document.getElementById('upcoming-hearings');
            if (withHearings.length > 0) {
                container.innerHTML = withHearings.slice(0, 5).map(r => `
                    <div class="p-4 rounded-lg bg-red-950/30 border border-red-800/50">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <p class="font-semibold text-red-300">Petition ${r.petition}</p>
                                    ${r.hearingDate ? `<span class="px-2 py-0.5 text-xs bg-red-900/70 text-red-200 rounded">Hearing: ${r.hearingDate}</span>` : ''}
                                    ${r.type === 'high-density' ? '<span class="px-2 py-0.5 text-xs bg-red-900/50 text-red-300 rounded">HIGH DENSITY</span>' : ''}
                                </div>
                                <p class="text-sm text-white">${r.address || 'Address pending'}</p>
                                <p class="text-xs text-slate-400 mt-1">${r.description}</p>
                                <p class="text-xs text-slate-500 mt-1">Petitioner: ${r.petitioner}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-500">Distance</p>
                                <p class="font-semibold text-emerald-400">${r.distance?.toFixed(1) || '?'} mi</p>
                            </div>
                        </div>
                        <div class="mt-3 flex gap-2 flex-wrap">
                            <a href="${r.link}" target="_blank" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded text-xs">View Details</a>
                            <a href="https://charlottenc.gov/planning/Rezoning/Pages/default.aspx" target="_blank" class="px-3 py-1 bg-red-900/50 hover:bg-red-800/50 text-red-300 rounded text-xs">Hearing Calendar</a>
                            <a href="mailto:rezoning@charlottenc.gov?subject=Comments on Petition ${r.petition}" class="px-3 py-1 bg-blue-900/50 hover:bg-blue-800/50 text-blue-300 rounded text-xs">Submit Comment</a>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="p-4 rounded-lg bg-slate-900 border border-slate-800">
                        <p class="text-slate-400 text-sm">No hearings with dates found in nearby petitions. Check the
                            <a href="https://charlottenc.gov/planning/Rezoning/Pages/default.aspx" target="_blank" class="text-blue-400 hover:underline">Charlotte Rezoning Calendar</a>
                            for the latest hearing schedule.
                        </p>
                    </div>
                `;
            }
        }

        function renderDeveloperScorecard() {
            // Count petitions by petitioner
            const devCounts = {};
            allRezonings.forEach(r => {
                const dev = r.petitioner?.trim() || 'Unknown';
                if (dev && dev !== 'Unknown') {
                    if (!devCounts[dev]) {
                        devCounts[dev] = { total: 0, highDensity: 0, nearby: 0, watched: r.isWatched };
                    }
                    devCounts[dev].total++;
                    if (r.type === 'high-density') devCounts[dev].highDensity++;
                    if (r.distance && r.distance <= SEARCH_RADIUS_MILES) devCounts[dev].nearby++;
                }
            });

            // Sort by total petitions
            const sorted = Object.entries(devCounts)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);

            const container = document.getElementById('developer-scorecard');
            if (sorted.length > 0) {
                container.innerHTML = `
                    <div class="overflow-x-auto rounded-lg border border-slate-800">
                        <table class="w-full">
                            <thead class="bg-slate-900">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-slate-400">DEVELOPER/PETITIONER</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-slate-400">TOTAL</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-slate-400">HIGH DENSITY</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-slate-400">NEAR YOU</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                ${sorted.map(([dev, counts]) => `
                                    <tr class="${counts.watched ? 'bg-purple-950/20' : ''}">
                                        <td class="px-4 py-2 font-semibold text-sm">
                                            ${dev}
                                            ${counts.watched ? '<span class="ml-2 px-1.5 py-0.5 text-xs bg-purple-900/50 text-purple-300 rounded">WATCHED</span>' : ''}
                                        </td>
                                        <td class="px-4 py-2 text-center text-slate-300">${counts.total}</td>
                                        <td class="px-4 py-2 text-center ${counts.highDensity > 0 ? 'text-red-400 font-semibold' : 'text-slate-500'}">${counts.highDensity}</td>
                                        <td class="px-4 py-2 text-center ${counts.nearby > 0 ? 'text-amber-400 font-semibold' : 'text-slate-500'}">${counts.nearby}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                container.innerHTML = '<p class="text-slate-500 text-sm p-4 bg-slate-900 rounded-lg border border-slate-800">No developer data available</p>';
            }
        }

        function exportSummary() {
            const criticalNearby = nearbyRezonings.filter(r => r.type === 'high-density');
            const lotSplits = nearbyRezonings.filter(r => r.type === 'lotsplit');

            const report = `
MAMMOTH OAKS / LANSDOWNE DEVELOPMENT REPORT
Generated: ${new Date().toLocaleDateString()}
================================================================================

SUMMARY
-------
• Total Active Rezonings in Charlotte: ${allRezonings.length}
• Rezonings Within 3 Miles: ${nearbyRezonings.length}
• High-Density Projects Nearby: ${criticalNearby.length}
• Lot Splits Nearby: ${lotSplits.length}
• Recent Sales Tracked: ${allSales.length}

HIGH-DENSITY PROJECTS NEAR US (Require Attention)
-------------------------------------------------
${criticalNearby.length > 0 ? criticalNearby.map(r => `
• Petition ${r.petition}
  Location: ${r.address || 'See petition details'}
  Change: ${r.currentZoning} → ${r.proposedZoning}
  Petitioner: ${r.petitioner}
  Distance: ${r.distance?.toFixed(1)} miles
  Link: ${r.link}
`).join('\n') : 'None currently'}

LOT SPLITS NEARBY
-----------------
${lotSplits.length > 0 ? lotSplits.map(r => `
• Petition ${r.petition}
  Location: ${r.address || 'See petition details'}
  Change: ${r.currentZoning} → ${r.proposedZoning}
  Distance: ${r.distance?.toFixed(1)} miles
`).join('\n') : 'None currently'}

HOW TO OPPOSE
-------------
1. 20% PROTEST PETITION: If 20%+ of adjacent landowners file a written protest,
   the rezoning requires 9/11 votes (supermajority) instead of 6/11.

2. ATTEND PUBLIC HEARING: Speak for 3 minutes about traffic, character,
   stormwater, and tree loss concerns.

3. SUBMIT WRITTEN COMMENTS: Email rezoning@charlottenc.gov

4. CONTACT DISTRICT 7 REP: Check charlottenc.gov/CityCouncil

================================================================================
Data Sources: Charlotte Planning ArcGIS, Mecklenburg POLARIS
For full interactive dashboard: Open mammoth-oaks-tracker.html
            `;

            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Mammoth Oaks Development Report</title>
                <style>
                    body { font-family: 'Courier New', monospace; font-size: 12px; padding: 20px; white-space: pre-wrap; }
                    @media print { body { font-size: 10px; } }
                </style>
                </head>
                <body>${report}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyEmailDraft() {
            const criticalNearby = nearbyRezonings.filter(r => r.type === 'high-density');

            const email = `Subject: Concerns Regarding Rezoning Petition(s) Near Mammoth Oaks/Lansdowne

Dear [Council Member/Planning Staff],

I am writing as a concerned resident of the Mammoth Oaks/Lansdowne neighborhood (ZIP 28270) regarding the following rezoning petition(s) that would significantly impact our community:

${criticalNearby.slice(0, 3).map(r => `• Petition ${r.petition}: ${r.currentZoning} → ${r.proposedZoning}
  Location: ${r.address || 'See petition'}
  Petitioner: ${r.petitioner}`).join('\n\n')}

Our concerns include:

1. TRAFFIC IMPACT: Our neighborhood streets were not designed for the increased traffic density these developments would bring. [Add specific streets/intersections of concern]

2. NEIGHBORHOOD CHARACTER: The proposed density is incompatible with the existing single-family character of our established neighborhood.

3. INFRASTRUCTURE: Stormwater management and utility infrastructure may be inadequate for the proposed density.

4. TREE CANOPY: High-density development typically results in significant tree loss, affecting property values and quality of life.

We respectfully request that you consider these concerns and the impact on existing residents when evaluating this petition.

Sincerely,
[Your Name]
[Your Address]
Mammoth Oaks/Lansdowne Neighborhood
`;

            navigator.clipboard.writeText(email).then(() => {
                alert('Email template copied to clipboard! Paste into your email client and customize.');
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = email;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Email template copied to clipboard! Paste into your email client and customize.');
            });
        }

        function renderActionTab() {
            renderUpcomingHearings();
            renderDeveloperScorecard();
            lucide.createIcons();
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-amber-600', 'text-white');
                el.classList.add('text-slate-400');
            });
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabId}"]`).classList.remove('text-slate-400');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('bg-amber-600', 'text-white');
        }

        function filterRezonings(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(el => {
                el.classList.remove('bg-amber-600', 'text-white');
                el.classList.add('bg-slate-800', 'text-slate-400');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.remove('bg-slate-800', 'text-slate-400');
            document.querySelector(`[data-filter="${filter}"]`).classList.add('bg-amber-600', 'text-white');
            renderAllRezonings();
        }

        function filterSales(filter) {
            currentSalesFilter = filter;
            document.querySelectorAll('.sales-filter-btn').forEach(el => {
                el.classList.remove('bg-amber-600', 'text-white');
                el.classList.add('bg-slate-800', 'text-slate-400');
            });
            document.querySelector(`[data-sales-filter="${filter}"]`).classList.remove('bg-slate-800', 'text-slate-400');
            document.querySelector(`[data-sales-filter="${filter}"]`).classList.add('bg-amber-600', 'text-white');
            renderSales();
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem(API_KEY_STORAGE, key);
                document.getElementById('api-key-status').textContent = 'API key saved! Refreshing sales data...';
                document.getElementById('api-key-status').className = 'text-xs text-emerald-400 mt-2';
                fetchSalesData().then(sales => {
                    allSales = sales;
                    renderSales();
                    renderOverview();
                });
            }
        }

        // ============================================
        // MAIN
        // ============================================

        async function refreshAllData() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('animate-spin');
            hideError();

            try {
                // Fetch rezonings
                const features = await fetchRezonings();
                allRezonings = await processRezonings(features);

                // Calculate distances and filter nearby
                nearbyRezonings = filterNearby(allRezonings);

                // Enrich with addresses (only for nearby ones)
                await enrichWithAddresses(allRezonings);

                // Fetch sales
                allSales = await fetchSalesData();

                // Render everything
                renderOverview();
                renderAllRezonings();
                renderNearbyRezonings();
                renderSales();
                renderActionTab();

                document.getElementById('last-updated').textContent = `Updated: ${new Date().toLocaleString()}`;
            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            }

            refreshIcon.classList.remove('animate-spin');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved API key status
            const apiKey = localStorage.getItem(API_KEY_STORAGE);
            if (apiKey) {
                document.getElementById('api-key-input').value = '••••••••••••••••';
                document.getElementById('api-key-status').textContent = 'Custom API key configured';
                document.getElementById('api-key-status').className = 'text-xs text-emerald-400 mt-2';
            } else {
                document.getElementById('api-key-status').textContent = 'Using built-in API key (50 calls/month shared)';
                document.getElementById('api-key-status').className = 'text-xs text-blue-400 mt-2';
            }

            lucide.createIcons();
            refreshAllData();
        });
    </script>
</body>
</html>
